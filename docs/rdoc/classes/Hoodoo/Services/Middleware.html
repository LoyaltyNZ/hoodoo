<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Hoodoo::Services::Middleware</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/github.css" type="text/css" media="screen" />
<script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            <span class="type">Class</span> 
            Hoodoo::Services::Middleware 
            
                <span class="parent">&lt; 
                    
                    Object
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/amqp_log_message_rb.html">lib/hoodoo/services/middleware/amqp_log_message.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/amqp_log_writer_rb.html">lib/hoodoo/services/middleware/amqp_log_writer.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/endpoint/augmented_array_rb.html">lib/hoodoo/services/middleware/endpoint/augmented_array.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/endpoint/augmented_base_rb.html">lib/hoodoo/services/middleware/endpoint/augmented_base.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/endpoint/augmented_hash_rb.html">lib/hoodoo/services/middleware/endpoint/augmented_hash.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/endpoint/endpoint_rb.html">lib/hoodoo/services/middleware/endpoint/endpoint.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/exception_reporting/base_reporter_rb.html">lib/hoodoo/services/middleware/exception_reporting/base_reporter.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/exception_reporting/exception_reporting_rb.html">lib/hoodoo/services/middleware/exception_reporting/exception_reporting.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/exception_reporting/reporters/airbrake_reporter_rb.html">lib/hoodoo/services/middleware/exception_reporting/reporters/airbrake_reporter.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/exception_reporting/reporters/raygun_reporter_rb.html">lib/hoodoo/services/middleware/exception_reporting/reporters/raygun_reporter.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/middleware_rb.html">lib/hoodoo/services/middleware/middleware.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/service_registry_drb_server_rb.html">lib/hoodoo/services/middleware/service_registry_drb_server.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/middleware/service_registry_drb_server_start_rb.html">lib/hoodoo/services/middleware/service_registry_drb_server_start.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/services/context_rb.html">lib/hoodoo/services/services/context.rb</a></li>
            
            <li><a href="../../../files/lib/hoodoo/services/services/interface_rb.html">lib/hoodoo/services/services/interface.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p><a href="../../Rack.html">Rack</a> middleware, declared in (e.g.) a
<code>config.ru</code> file in the usual way:</p>

<pre><code>use( Hoodoo::Services::Middleware )
</code></pre>

<p>This is the core of the common service implementation on the <a
href="../../Rack.html">Rack</a> client-request-handling side. It is run in
the context of an <a href="Service.html">Hoodoo::Services::Service</a>
subclass that&#39;s been given to <a href="../../Rack.html">Rack</a> as the
<a href="../../Rack.html">Rack</a> endpoint application; it looks at the
component interfaces supported by the service and routes requests to the
correct one (or raises a 404).</p>

<p>Lots of preprocessing and postprocessing gets done to set up things like
locale information, enforce content types and so-forth. <a
href="Request.html">Request</a> data is assembled in a parsed, structured
format for passing to service implementations and a response object built
so that services have a consistent way to return results, which can be
post-processed further by the middleware before returning the data to <a
href="../../Rack.html">Rack</a>.</p>

<p>The middleware supports structured logging through <a
href="../Logger.html">Hoodoo::Logger</a> via the custom <a
href="Middleware/AMQPLogWriter.html">Hoodoo::Services::Middleware::AMQPLogWriter</a>
class. Access the logger instance with <a
href="Middleware.html#method-c-logger">::logger</a>. Call
<code>report</code> on this (see <a
href="../Logger/WriterMixin.html#method-i-report">Hoodoo::Logger::WriterMixin#report</a>)
to make structured log entries. The middleware&#39;s own entries use
component <code>Middleware</code> for general data. It also logs essential
essential information about successful and failed interactions with
resource endpoints using the resource name as the component. In such cases,
the codes it uses are always prefixed by <code>middleware_</code> and
service applications must consider codes with this prefix reserved - do not
use such codes yourself.</p>

<p>The middleware adds a STDERR stream writer logger by default and an AMQP
log writer on the first <a href="../../Rack.html">Rack</a>
<code>call</code> should the <a href="../../Rack.html">Rack</a> environment
provide an Alchemy endpoint (see the Alchemy and AMQEndpoint gems).</p>

    </div>
  


  


  
  


  
    <!-- Namespace -->
    <div class="sectiontitle">Namespace</div>
    <ul>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Middleware/AMQPLogMessage.html">Hoodoo::Services::Middleware::AMQPLogMessage</a>
        </li>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Middleware/AMQPLogWriter.html">Hoodoo::Services::Middleware::AMQPLogWriter</a>
        </li>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Middleware/Endpoint.html">Hoodoo::Services::Middleware::Endpoint</a>
        </li>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Middleware/ExceptionReporting.html">Hoodoo::Services::Middleware::ExceptionReporting</a>
        </li>
      
        <li>
          <span class="type">CLASS</span>
          <a href="Middleware/ServiceRegistryDRbServer.html">Hoodoo::Services::Middleware::ServiceRegistryDRbServer</a>
        </li>
      
    </ul>
  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>#</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-_call">_call</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-call">call</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-environment">environment</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>H</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-has_memcache-3F">has_memcache?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-inter_resource">inter_resource</a>,
              </li>
            
              
              <li>
                <a href="#method-i-inter_resource_local">inter_resource_local</a>,
              </li>
            
              
              <li>
                <a href="#method-i-inter_resource_remote">inter_resource_remote</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-local_service_for">local_service_for</a>,
              </li>
            
              
              <li>
                <a href="#method-c-logger">logger</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-new">new</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-on_queue-3F">on_queue?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-record_host_and_port">record_host_and_port</a>,
              </li>
            
              
              <li>
                <a href="#method-i-remote_service_for">remote_service_for</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-set_log_folder">set_log_folder</a>,
              </li>
            
              
              <li>
                <a href="#method-c-set_logger">set_logger</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-translate_errors_from_other_resource">translate_errors_from_other_resource</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    
      <!-- Section constants -->
      <div class="sectiontitle">Constants</div>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">ALLOWED_ACTIONS</td>
            <td>=</td>
            <td class="attr-value">[
:list,
:show,
:create,
:update,
:delete,
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>All allowed action names in implementations, used for internal checks. This
is also the default supported set of actions. Symbols.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ALLOWED_QUERIES_LIST</td>
            <td>=</td>
            <td class="attr-value">[
&#39;offset&#39;,
&#39;limit&#39;,
&#39;sort&#39;,
&#39;direction&#39;,
&#39;search&#39;,
&#39;filter&#39;
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Allowed common fields in query strings (list actions only). Strings.</p>

<p>Only ever <strong>add</strong> to this list. As the API evolves, legacy
clients will be calling with previously documented query strings and
removing any entries from the list below could cause their requests to be
rejected with a &#39;platform.malformed&#39; error.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ALLOWED_QUERIES_ALL</td>
            <td>=</td>
            <td class="attr-value">[
&#39;_embed&#39;,
&#39;_reference&#39;
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Allowed common fields in query strings (all actions). Strings. Adds to the
::ALLOWED_QUERIES_LIST for list actions.</p>

<p>Only ever <strong>add</strong> to this list. As the API evolves, legacy
clients will be calling with previously documented query strings and
removing any entries from the list below could cause their requests to be
rejected with a &#39;platform.malformed&#39; error.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">SUPPORTED_MEDIA_TYPES</td>
            <td>=</td>
            <td class="attr-value">[ &#39;application/json&#39; ]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Allowed media types in Content-Type headers.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">SUPPORTED_ENCODINGS</td>
            <td>=</td>
            <td class="attr-value">[ &#39;utf-8&#39; ]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Allowed (required) charsets in Content-Type headers.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">MAXIMUM_PAYLOAD_SIZE</td>
            <td>=</td>
            <td class="attr-value">1048576</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Somewhat arbitrary maximum incoming payload size to prevent ham-fisted DOS
attempts to consume RAM.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">MAXIMUM_LOGGED_PAYLOAD_SIZE</td>
            <td>=</td>
            <td class="attr-value">1024</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Maximum <strong>logged</strong> payload size.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">FRONT_OBJECT</td>
            <td>=</td>
            <td class="attr-value">Hoodoo::Services::Middleware::ServiceRegistryDRbServer.new</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Singleton “Front object” for the DRB service used in local development.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">LOCAL_ACL</td>
            <td>=</td>
            <td class="attr-value">ACL.new( [ &#39;deny&#39;, &#39;all&#39;, &#39;allow&#39;, &#39;127.0.0.1&#39; ] )</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Only allow connections from 127.0.0.1.</p></td>
            </tr>
          
        
      </table>
    


    


    <!-- Methods -->
    
      <div class="sectiontitle">Class Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-c-environment">
            
              <b>environment</b>()
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-c-environment" name="method-c-environment" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Utility - returns the execution environment as a Rails-like environment
object which answers queries like <code>production?</code> or
<code>staging?</code> with <code>true</code> or <code>false</code>
according to the <code>RACK_ENV</code> environment variable setting.</p>

<p>Example:</p>

<pre><code>if Hoodoo::Services::Middleware.environment.production?
  # ...do something only if RACK_ENV=&quot;production&quot;
end
</code></pre>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-environment_source')" id="l_method-c-environment_source">show</a>
                
              </p>
              <div id="method-c-environment_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 123</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">self</span>.<span class="ruby-identifier">environment</span>
  <span class="ruby-identifier">@@_env</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">StringInquirer</span>.<span class="ruby-identifier">new</span>( <span class="ruby-constant">ENV</span>[ <span class="ruby-string">&#39;RACK_ENV&#39;</span> ] <span class="ruby-operator">||</span> <span class="ruby-string">&#39;development&#39;</span> )
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-has_memcache-3F">
            
              <b>has_memcache?</b>()
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-c-has_memcache-3F" name="method-c-has_memcache-3F" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Do we have Memcache available? If not, assume local development with higher
level queue services not available. Most service authors should not ever
need to check this.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-has_memcache-3F_source')" id="l_method-c-has_memcache-3F_source">show</a>
                
              </p>
              <div id="method-c-has_memcache-3F_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 131</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">self</span>.<span class="ruby-identifier">has_memcache?</span>
  <span class="ruby-identifier">m</span> = <span class="ruby-constant">ENV</span>[ <span class="ruby-string">&#39;MEMCACHE_URL&#39;</span> ]
  <span class="ruby-identifier">m</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-logger">
            
              <b>logger</b>()
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-c-logger" name="method-c-logger" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Access the middleware&#39;s logging instance. Call <code>report</code> on
this to make structured log entries. See <a
href="../Logger/WriterMixin.html#method-i-report">Hoodoo::Logger::WriterMixin#report</a>
along with <a href="../Logger.html">Hoodoo::Logger</a> for other calls you
can use.</p>

<p>The logging system &#39;wakes up&#39; in stages. Initially, only console
based output is added, as the <a href="Middleware.html">Middleware</a> Ruby
code is parsed and configures a basic logger. If you call <a
href="Middleware.html#method-c-set_log_folder">::set_log_folder</a>,
file-based logging may be available. In AMQP based environments, queue
based logging will become automatically available via <a
href="../../Rack.html">Rack</a> and the Alchemy gem once the middleware
starts handling its very first request, but not before.</p>

<p>With this in mind, the logger is ultimately configured with a set of
writers as follows:</p>
<ul><li>
<p>If off queue:</p>
<ul><li>
<p>All RACK_ENV values (including “test”):</p>
<ul><li>
<p>File “log/{environment}.log”</p>
</li></ul>
</li><li>
<p>RACK_ENV “development”</p>
<ul><li>
<p>Also to $stdout</p>
</li></ul>
</li></ul>
</li><li>
<p>If on queue:</p>
<ul><li>
<p>RACK ENV “test”</p>
<ul><li>
<p>File “log/test.log”</p>
</li></ul>
</li><li>
<p>All other RACK_ENV values</p>
<ul><li>
<p>AMQP writer (see below)</p>
</li></ul>
</li><li>
<p>RACK_ENV “development”</p>
<ul><li>
<p>Also to $stdout</p>
</li></ul>
</li></ul>
</li></ul>

<p>Or to put it another way, in test mode only file output to
&#39;test.log&#39; happens; in development mode $stdout always happens; and
in addition for non-test environment, you&#39;ll get a queue-based or
file-based logger depending on whether or not a queue is available.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-logger_source')" id="l_method-c-logger_source">show</a>
                
              </p>
              <div id="method-c-logger_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 176</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">self</span>.<span class="ruby-identifier">logger</span>
  <span class="ruby-identifier">@@logger</span> <span class="ruby-comment"># See self.set_up_basic_logging and self.set_logger</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-new">
            
              <b>new</b>( app )
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-c-new" name="method-c-new" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Initialize the middleware instance.</p>

<p><code>app</code> <a href="../../Rack.html">Rack</a> app instance to which
calls should be passed.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 230</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">initialize</span>( <span class="ruby-identifier">app</span> )

  <span class="ruby-identifier">service_container</span> = <span class="ruby-identifier">app</span>

  <span class="ruby-keyword">if</span> <span class="ruby-keyword">defined?</span>( <span class="ruby-constant">NewRelic</span> ) <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-keyword">defined?</span>( <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span> ) <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-keyword">defined?</span>( <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">Instrumentation</span> ) <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-keyword">defined?</span>( <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">Instrumentation</span><span class="ruby-operator">::</span><span class="ruby-constant">MiddlewareProxy</span> ) <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-identifier">service_container</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">Instrumentation</span><span class="ruby-operator">::</span><span class="ruby-constant">MiddlewareProxy</span> )

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">service_container</span>.<span class="ruby-identifier">respond_to?</span>( <span class="ruby-value">:target</span> )
      <span class="ruby-identifier">newrelic_wrapper</span>  = <span class="ruby-identifier">service_container</span>
      <span class="ruby-identifier">service_container</span> = <span class="ruby-identifier">service_container</span>.<span class="ruby-identifier">target</span>()
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Hoodoo::Services::Middleware instance created with NewRelic-wrapped Service entity, but NewRelic API is not as expected by Hoodoo; incompatible NewRelic version.&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">service_container</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Service</span> )
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Hoodoo::Services::Middleware instance created with non-Service entity of class &#39;#{ service_container.class }&#39; - is this the last middleware in the chain via &#39;use()&#39; and is Rack &#39;run()&#39;-ing the correct thing?&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Collect together the implementation instances and the matching regexps</span>
  <span class="ruby-comment"># for endpoints. An array of hashes.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># Key              Value</span>
  <span class="ruby-comment"># =======================================================================</span>
  <span class="ruby-comment"># regexp           Regexp for +String#match+ on the URI path component</span>
  <span class="ruby-comment"># interface        Hoodoo::Services::Interface subclass associated with</span>
  <span class="ruby-comment">#                  the endpoint regular expression in +regexp+</span>
  <span class="ruby-comment"># actions          Set of symbols naming allowed actions</span>
  <span class="ruby-comment"># implementation   Hoodoo::Services::Implementation subclass *instance* to</span>
  <span class="ruby-comment">#                  use on match</span>

  <span class="ruby-identifier">@@services</span> = <span class="ruby-identifier">service_container</span>.<span class="ruby-identifier">component_interfaces</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">interface</span> <span class="ruby-operator">|</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">endpoint</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">implementation</span>.<span class="ruby-identifier">nil?</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Hoodoo::Services::Middleware encountered invalid interface class #{ interface } via service class #{ service_container.class }&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># If anything uses a public interface, we need to tell ourselves that</span>
    <span class="ruby-comment"># the early exit session check can&#39;t be done.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-identifier">interfaces_have_public_methods</span>() <span class="ruby-keyword">unless</span> <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">public_actions</span>.<span class="ruby-identifier">empty?</span>

    <span class="ruby-comment"># Regexp explanation:</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># Match &quot;/&quot;, the version text, &quot;/&quot;, the endpoint text, then either</span>
    <span class="ruby-comment"># another &quot;/&quot;, a &quot;.&quot; or the end of the string, followed by capturing</span>
    <span class="ruby-comment"># everything else. Match data index 1 will be whatever character (if</span>
    <span class="ruby-comment"># any) followed after the endpoint (&quot;/&quot; or &quot;.&quot;) while index 2 contains</span>
    <span class="ruby-comment"># everything else.</span>

    {
      <span class="ruby-value">:regexp</span>         =<span class="ruby-operator">&gt;</span> <span class="ruby-node">/\/v#{ interface.version }\/#{ interface.endpoint }(\.|\/|$)(.*)/</span>,
      <span class="ruby-value">:path</span>           =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;/v#{ interface.version }/#{ interface.endpoint }&quot;</span>,
      <span class="ruby-value">:interface</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">interface</span>,
      <span class="ruby-value">:implementation</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">implementation</span>.<span class="ruby-identifier">new</span>
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">announce_presence_of</span>( <span class="ruby-identifier">@@services</span> )
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-on_queue-3F">
            
              <b>on_queue?</b>()
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-c-on_queue-3F" name="method-c-on_queue-3F" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Are we running on the queue, else (implied) a local HTTP server?</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-on_queue-3F_source')" id="l_method-c-on_queue-3F_source">show</a>
                
              </p>
              <div id="method-c-on_queue-3F_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 138</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">self</span>.<span class="ruby-identifier">on_queue?</span>
  <span class="ruby-identifier">q</span> = <span class="ruby-constant">ENV</span>[ <span class="ruby-string">&#39;AMQ_ENDPOINT&#39;</span> ]
  <span class="ruby-identifier">q</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">q</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-record_host_and_port">
            
              <b>record_host_and_port</b>( options = {} )
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-c-record_host_and_port" name="method-c-record_host_and_port" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Record internally the HTTP host and port during local development via e.g
<code>rackup</code> or testing with rspec. This is usually not called
directly except via the <a href="../../Rack.html">Rack</a> startup monkey
patch code in <code>rack_monkey_patch.rb</code>.</p>

<p>Options hash <code>:Host</code> and <code>:Port</code> entries are
recorded.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-record_host_and_port_source')" id="l_method-c-record_host_and_port_source">show</a>
                
              </p>
              <div id="method-c-record_host_and_port_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 221</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">self</span>.<span class="ruby-identifier">record_host_and_port</span>( <span class="ruby-identifier">options</span> = {} )
  <span class="ruby-identifier">@@recorded_host</span> = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:Host</span> ]
  <span class="ruby-identifier">@@recorded_port</span> = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:Port</span> ]
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-set_log_folder">
            
              <b>set_log_folder</b>( base_path )
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-c-set_log_folder" name="method-c-set_log_folder" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>If using the middleware logger (see <a
href="Middleware.html#method-c-logger">::logger</a>) with no external
custom logger set up (see <a
href="Middleware.html#method-c-set_logger">::set_logger</a>), call here to
configure the folder used for logs when file output is active.</p>

<p>If you don&#39;t do this at least once, no log file output can occur.</p>

<p>You can call more than once to output to more than one log folder.</p>
<dl class="rdoc-list note-list"><dt><code>base_path</code>
<dd>
<p>Path to folder to use for logs; file “#{environment}.log” may be written
inside (see <a
href="Middleware.html#method-c-environment">::environment</a>).</p>
</dd></dl>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-set_log_folder_source')" id="l_method-c-set_log_folder_source">show</a>
                
              </p>
              <div id="method-c-set_log_folder_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 210</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">self</span>.<span class="ruby-identifier">set_log_folder</span>( <span class="ruby-identifier">base_path</span> )
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span>( <span class="ruby-value">:add_file_logging</span>, <span class="ruby-identifier">base_path</span> )
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-set_logger">
            
              <b>set_logger</b>( logger )
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-c-set_logger" name="method-c-set_logger" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>The middleware sets up a logger itself (see <a
href="Middleware.html#method-c-logger">::logger</a>) with various log
mechanisms set up (mostly) without service author intervention.</p>

<p>If you want to completely override the middleware&#39;s logger and replace
it with your own at any time (not recommended), call here.</p>
<dl class="rdoc-list note-list"><dt><code>logger</code>
<dd>
<p>Alternative <a href="../Logger.html">Hoodoo::Logger</a> instance to use for
all middleware logging from this point onwards. The value will subsequently
be returned by the <a href="Middleware.html#method-c-logger">::logger</a>
class method.</p>
</dd></dl>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-set_logger_source')" id="l_method-c-set_logger_source">show</a>
                
              </p>
              <div id="method-c-set_logger_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 190</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">self</span>.<span class="ruby-identifier">set_logger</span>( <span class="ruby-identifier">logger</span> )
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Logger</span> )
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Hoodoo::Communicators::set_logger must be called with an instance of Hoodoo::Logger only&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">@@external_logger</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-identifier">@@logger</span>          = <span class="ruby-identifier">logger</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                  
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-_call">
            
              <b>_call</b>( env )
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-i-_call" name="method-i-_call" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Run a <a href="../../Rack.html">Rack</a> request, returning the [status,
headers, body-array] data as per the <a href="../../Rack.html">Rack</a>
protocol requirements. Called via <a
href="Middleware.html#method-i-call">call</a>, in a duplicated instance for
thread safety.</p>

<p><code>env</code> <a href="../../Rack.html">Rack</a> environment.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-_call_source')" id="l_method-i-_call_source">show</a>
                
              </p>
              <div id="method-i-_call_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 311</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">_call</span>( <span class="ruby-identifier">env</span> )

  <span class="ruby-comment"># Global exception handler - catch problems in service implementations</span>
  <span class="ruby-comment"># and send back a 500 response as per API documentation (if possible).</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-keyword">begin</span>

    <span class="ruby-ivar">@rack_request</span> = <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Request</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">env</span> )

    <span class="ruby-identifier">alchemy</span> = <span class="ruby-identifier">env</span>[ <span class="ruby-string">&#39;rack.alchemy&#39;</span> ]
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">alchemy</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">defined?</span>( <span class="ruby-identifier">@@alchemy</span> )
      <span class="ruby-identifier">@@alchemy</span> = <span class="ruby-identifier">alchemy</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">send</span>( <span class="ruby-value">:add_queue_logging</span>, <span class="ruby-identifier">@@alchemy</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">@@alchemy</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">debug_log</span>()

    <span class="ruby-identifier">early_response</span> = <span class="ruby-identifier">preprocess</span>()
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">early_response</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">early_response</span>.<span class="ruby-identifier">nil?</span>

    <span class="ruby-identifier">process</span>()     <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@response</span>.<span class="ruby-identifier">halt_processing?</span>
    <span class="ruby-identifier">postprocess</span>() <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@response</span>.<span class="ruby-identifier">halt_processing?</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">respond_with</span>( <span class="ruby-ivar">@response</span>.<span class="ruby-identifier">for_rack</span>() )

  <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exception</span>
    <span class="ruby-keyword">begin</span>

      <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">environment</span>.<span class="ruby-identifier">test?</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">environment</span>.<span class="ruby-identifier">development?</span>
        <span class="ruby-constant">ExceptionReporting</span>.<span class="ruby-identifier">report</span>( <span class="ruby-identifier">exception</span>, <span class="ruby-identifier">env</span> )
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">return</span> <span class="ruby-identifier">respond_with</span>( <span class="ruby-identifier">record_exception</span>( <span class="ruby-ivar">@response</span>, <span class="ruby-identifier">exception</span> ) )

    <span class="ruby-keyword">rescue</span>

      <span class="ruby-keyword">begin</span>
        <span class="ruby-identifier">@@logger</span>.<span class="ruby-identifier">error</span>(
          <span class="ruby-string">&#39;Hoodoo::Services::Middleware#call&#39;</span>,
          <span class="ruby-string">&#39;Middleware exception in exception handler&#39;</span>,
          <span class="ruby-identifier">exception</span>.<span class="ruby-identifier">to_s</span>
        )
      <span class="ruby-keyword">rescue</span>
        <span class="ruby-comment"># Ignore logger exceptions. Can&#39;t do anything about them. Just</span>
        <span class="ruby-comment"># try and get the response back to the client now.</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># An exception in the exception handler! Oh dear.</span>
      <span class="ruby-comment">#</span>
      <span class="ruby-identifier">rack_response</span> = <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Response</span>.<span class="ruby-identifier">new</span>
      <span class="ruby-identifier">rack_response</span>.<span class="ruby-identifier">status</span> = <span class="ruby-number">500</span>
      <span class="ruby-identifier">rack_response</span>.<span class="ruby-identifier">write</span>( <span class="ruby-string">&#39;Middleware exception in exception handler&#39;</span> )
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">rack_response</span>.<span class="ruby-identifier">finish</span>

    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-call">
            
              <b>call</b>( env )
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-i-call" name="method-i-call" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Run a <a href="../../Rack.html">Rack</a> request, returning the [status,
headers, body-array] data as per the <a href="../../Rack.html">Rack</a>
protocol requirements.</p>

<p>Duplicates “this” instance for thread safety and invokes #_call.</p>

<p><code>env</code> <a href="../../Rack.html">Rack</a> environment.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-call_source')" id="l_method-i-call_source">show</a>
                
              </p>
              <div id="method-i-call_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 301</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">call</span>( <span class="ruby-identifier">env</span> )
  <span class="ruby-identifier">dup</span>.<span class="ruby-identifier">_call</span>( <span class="ruby-identifier">env</span> )
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
              
      <div class="sectiontitle">Instance Protected methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-inter_resource">
            
              <b>inter_resource</b>( options )
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-i-inter_resource" name="method-i-inter_resource" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Perform an inter-resource call. This shouldn&#39;t be called directly; call
via the <a
href="Middleware/Endpoint.html">Hoodoo::Services::Middleware::Endpoint</a>
subclass specialised methods instead, which makes sure it sets up the
required parameters in correct combinations. Undefined results will arise
for incorrect calls.</p>
<dl class="rdoc-list note-list"><dt><code>options</code>
<dd>
<p>Options hash with keys and required values described below.</p>
</dd></dl>

<p>Options are as follows - keys must be Symbols:</p>
<dl class="rdoc-list note-list"><dt><code>local</code>
<dd>
<p>A +@@services+ entry (see implementation of initialize) describing the
service to call if local, else <code>nil</code> or absent for remote calls.</p>
</dd><dt><code>remote</code>
<dd>
<p>A return value of <a
href="Middleware.html#method-i-remote_service_for">remote_service_for</a>
describing the location of a service for remote calls, else
<code>nil</code> or absent for local calls.</p>
</dd><dt><code>resource</code>
<dd>
<p>The String or Symbol resource name, e.g. “Product”.</p>
</dd><dt><code>version</code>
<dd>
<p>The Integer endpoint API version, e.g. 2.</p>
</dd><dt><code>http_method</code>
<dd>
<p>HTTP method as a String, e.g. “<code>GET</code>”, “<code>DELETE</code>”.</p>
</dd><dt><code>ident</code>
<dd>
<p>ID / <a href="../UUID.html">UUID</a> / similar; first and only path
component.</p>
</dd><dt><code>query_hash</code>
<dd>
<p>Converted to query string.</p>
</dd><dt><code>body_hash</code>
<dd>
<p>Converted to body data.</p>
</dd></dl>

<p>Parameters should be nil where the value would not be allowed given the
HTTP method. HTTP methods must map to understood actions.</p>

<p>An <a
href="Middleware/Endpoint/AugmentedArray.html">Hoodoo::Services::Middleware::Endpoint::AugmentedArray</a>
or <a
href="Middleware/Endpoint/AugmentedHash.html">Hoodoo::Services::Middleware::Endpoint::AugmentedHash</a>
is returned from these methods; @response or the wider processing context
is not automatically modified. Callers MUST use the methods provided by <a
href="Middleware/Endpoint/AugmentedBase.html">Hoodoo::Services::Middleware::Endpoint::AugmentedBase</a>
to detect and handle error conditions, unless for some reason they wish to
ignore resource-to-resource call errors.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-inter_resource_source')" id="l_method-i-inter_resource_source">show</a>
                
              </p>
              <div id="method-i-inter_resource_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 1737</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">inter_resource</span>( <span class="ruby-identifier">options</span> )

  <span class="ruby-identifier">remote</span> = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:local</span> ].<span class="ruby-identifier">nil?</span>

  <span class="ruby-comment"># Don&#39;t use string composition here; profiling shows it is slow and</span>
  <span class="ruby-comment"># this is only for debugging anyway.</span>

  <span class="ruby-identifier">debug_str</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">remote</span>
    <span class="ruby-string">&#39;Remote inter-resource call&#39;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-string">&#39;Local inter-resource call&#39;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">debug_log</span>( <span class="ruby-identifier">debug_str</span>, <span class="ruby-string">&#39;requested&#39;</span>, <span class="ruby-identifier">options</span> )

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">remote</span> )
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">inter_resource_remote</span>( <span class="ruby-identifier">options</span> )
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">inter_resource_local</span>( <span class="ruby-identifier">options</span> )
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">platform_errors</span>.<span class="ruby-identifier">has_errors?</span>
    <span class="ruby-identifier">debug_log</span>( <span class="ruby-identifier">debug_str</span>, <span class="ruby-string">&#39;halted processing&#39;</span>, <span class="ruby-identifier">result</span>.<span class="ruby-identifier">platform_errors</span> )
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">debug_log</span>( <span class="ruby-identifier">debug_str</span>, <span class="ruby-string">&#39;succeeded&#39;</span>, <span class="ruby-identifier">result</span> )
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-inter_resource_local">
            
              <b>inter_resource_local</b>( options )
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-i-inter_resource_local" name="method-i-inter_resource_local" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Make a local (non-HTTP local Ruby method call) inter-resource call. Fast.</p>
<dl class="rdoc-list note-list"><dt>options
<dd>
<p>See <a href="Middleware.html#method-i-inter_resource">inter_resource</a>.</p>
</dd><dt>Returns
<dd>
<p>See <a href="Middleware.html#method-i-inter_resource">inter_resource</a>.</p>
</dd></dl>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-inter_resource_local_source')" id="l_method-i-inter_resource_local_source">show</a>
                
              </p>
              <div id="method-i-inter_resource_local_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 1950</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">inter_resource_local</span>( <span class="ruby-identifier">options</span> )
  <span class="ruby-identifier">service</span>        = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:local</span>       ]
  <span class="ruby-identifier">http_method</span>    = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:http_method</span> ]
  <span class="ruby-identifier">ident</span>          = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:ident</span>       ]
  <span class="ruby-identifier">body_hash</span>      = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:body_hash</span>   ]
  <span class="ruby-identifier">query_hash</span>     = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:query_hash</span>  ]

  <span class="ruby-identifier">interface</span>      = <span class="ruby-identifier">service</span>[ <span class="ruby-value">:interface</span>      ]
  <span class="ruby-identifier">actions</span>        = <span class="ruby-identifier">service</span>[ <span class="ruby-value">:actions</span>        ]
  <span class="ruby-identifier">implementation</span> = <span class="ruby-identifier">service</span>[ <span class="ruby-value">:implementation</span> ]

  <span class="ruby-comment"># We must construct a call context for the local service. This means</span>
  <span class="ruby-comment"># a local request object which we fill in with data just as if we&#39;d</span>
  <span class="ruby-comment"># parsed an inbound HTTP request and a response object that contains</span>
  <span class="ruby-comment"># the usual default data.</span>

  <span class="ruby-identifier">local_response</span> = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Response</span>.<span class="ruby-identifier">new</span>( <span class="ruby-ivar">@interaction_id</span> )
  <span class="ruby-identifier">set_common_response_headers</span>( <span class="ruby-identifier">local_response</span> )
  <span class="ruby-identifier">update_response_for</span>( <span class="ruby-identifier">local_response</span>, <span class="ruby-identifier">interface</span> )

  <span class="ruby-identifier">upc</span>  = []
  <span class="ruby-identifier">upc</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ident</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">empty?</span>

  <span class="ruby-identifier">action</span> = <span class="ruby-identifier">determine_action</span>(
    <span class="ruby-identifier">interface</span>,
    <span class="ruby-identifier">http_method</span>,
    <span class="ruby-identifier">upc</span>.<span class="ruby-identifier">empty?</span>,
    <span class="ruby-identifier">local_response</span>
  )

  <span class="ruby-comment"># Add errors from the local service response into an augmented hash</span>
  <span class="ruby-comment"># for responding early (via a Proc for internal reuse later).</span>

  <span class="ruby-identifier">add_local_errors</span> = <span class="ruby-constant">Proc</span>.<span class="ruby-identifier">new</span> {
    <span class="ruby-identifier">hash</span> = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span><span class="ruby-operator">::</span><span class="ruby-constant">Endpoint</span><span class="ruby-operator">::</span><span class="ruby-constant">AugmentedHash</span>.<span class="ruby-identifier">new</span>
    <span class="ruby-identifier">hash</span>.<span class="ruby-identifier">platform_errors</span>.<span class="ruby-identifier">merge!</span>( <span class="ruby-identifier">local_response</span>.<span class="ruby-identifier">errors</span> )
    <span class="ruby-identifier">hash</span>
  }

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">add_local_errors</span>.<span class="ruby-identifier">call</span>() <span class="ruby-keyword">if</span> <span class="ruby-identifier">local_response</span>.<span class="ruby-identifier">halt_processing?</span>

  <span class="ruby-identifier">local_request</span>                     = <span class="ruby-identifier">new_request_for</span>( <span class="ruby-identifier">interface</span> )
  <span class="ruby-identifier">local_request</span>.<span class="ruby-identifier">uri_path_components</span> = <span class="ruby-identifier">upc</span>
  <span class="ruby-identifier">local_request</span>.<span class="ruby-identifier">uri_path_extension</span>  = <span class="ruby-string">&#39;&#39;</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">query_hash</span> = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Utilities</span>.<span class="ruby-identifier">stringify</span>( <span class="ruby-identifier">query_hash</span> )

    <span class="ruby-comment"># This is for inter-resource local calls where a service author</span>
    <span class="ruby-comment"># specifies &quot;:_embed =&gt; &#39;foo&#39;&quot; accidentally, forgetting that it</span>
    <span class="ruby-comment"># should be a single element array. It&#39;s such a common mistake</span>
    <span class="ruby-comment"># that we tolerate it here. Same for &quot;_reference&quot;.</span>

    <span class="ruby-identifier">data</span> = <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span> ]
    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span> ] = [ <span class="ruby-identifier">data</span> ] <span class="ruby-keyword">if</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">String</span> ) <span class="ruby-operator">||</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Symbol</span> )

    <span class="ruby-identifier">data</span> = <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ]
    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ] = [ <span class="ruby-identifier">data</span> ] <span class="ruby-keyword">if</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">String</span> ) <span class="ruby-operator">||</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Symbol</span> )

    <span class="ruby-comment"># Regardless, make sure embed/reference array data contains strings.</span>

    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ].<span class="ruby-identifier">map!</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_s</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ].<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ].<span class="ruby-identifier">map!</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_s</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ].<span class="ruby-identifier">nil?</span>

    <span class="ruby-identifier">process_query_hash</span>(
      <span class="ruby-identifier">action</span>,
      <span class="ruby-identifier">query_hash</span>,
      <span class="ruby-identifier">interface</span>,
      <span class="ruby-identifier">local_request</span>,
      <span class="ruby-identifier">local_response</span>
    )
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">local_request</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">body_hash</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">action</span> <span class="ruby-operator">==</span> <span class="ruby-value">:create</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">action</span> <span class="ruby-operator">==</span> <span class="ruby-value">:update</span> )
    <span class="ruby-identifier">validate_body_data_for</span>( <span class="ruby-identifier">action</span>,
                            <span class="ruby-identifier">interface</span>,
                            <span class="ruby-identifier">body_hash</span>,
                            <span class="ruby-identifier">local_response</span> )
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">add_local_errors</span>.<span class="ruby-identifier">call</span>() <span class="ruby-keyword">if</span> <span class="ruby-identifier">local_response</span>.<span class="ruby-identifier">halt_processing?</span>

  <span class="ruby-comment"># Dispatch the call, merge any errors that might have come back and</span>
  <span class="ruby-comment"># return the body of the called service&#39;s response.</span>

  <span class="ruby-identifier">debug_log</span>( <span class="ruby-string">&#39;Dispatching local inter-resource call&#39;</span>, <span class="ruby-identifier">local_request</span>.<span class="ruby-identifier">body</span> )

  <span class="ruby-identifier">context</span> = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Context</span>.<span class="ruby-identifier">new</span>(
    <span class="ruby-ivar">@session</span>,
    <span class="ruby-identifier">local_request</span>,
    <span class="ruby-identifier">local_response</span>,
    <span class="ruby-keyword">self</span>
  )

  <span class="ruby-identifier">dispatch_to</span>( <span class="ruby-identifier">interface</span>, <span class="ruby-identifier">implementation</span>, <span class="ruby-identifier">action</span>, <span class="ruby-identifier">context</span> )

  <span class="ruby-comment"># Extract the returned data and &quot;rephrase&quot; it as an augmented</span>
  <span class="ruby-comment"># array or hash carrying error data if necessary.</span>

  <span class="ruby-identifier">data</span> = <span class="ruby-identifier">local_response</span>.<span class="ruby-identifier">body</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Array</span>
    <span class="ruby-identifier">data</span> = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span><span class="ruby-operator">::</span><span class="ruby-constant">Endpoint</span><span class="ruby-operator">::</span><span class="ruby-constant">AugmentedArray</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">data</span> )
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">data</span> = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span><span class="ruby-operator">::</span><span class="ruby-constant">Endpoint</span><span class="ruby-operator">::</span><span class="ruby-constant">AugmentedHash</span>[ <span class="ruby-identifier">data</span> ]
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">data</span>.<span class="ruby-identifier">set_platform_errors</span>(
    <span class="ruby-identifier">translate_errors_from_other_resource</span>( <span class="ruby-identifier">local_response</span>.<span class="ruby-identifier">errors</span> )
  )

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">data</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-inter_resource_remote">
            
              <b>inter_resource_remote</b>( options )
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-i-inter_resource_remote" name="method-i-inter_resource_remote" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Make a remote (HTTP) inter-resource call. Slow.</p>
<dl class="rdoc-list note-list"><dt>options
<dd>
<p>See <a href="Middleware.html#method-i-inter_resource">inter_resource</a>.</p>
</dd><dt>Returns
<dd>
<p>See <a href="Middleware.html#method-i-inter_resource">inter_resource</a>.</p>
</dd></dl>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-inter_resource_remote_source')" id="l_method-i-inter_resource_remote_source">show</a>
                
              </p>
              <div id="method-i-inter_resource_remote_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 1773</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">inter_resource_remote</span>( <span class="ruby-identifier">options</span> )
  <span class="ruby-identifier">remote_info</span> = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:remote</span>      ]
  <span class="ruby-identifier">http_method</span> = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:http_method</span> ]
  <span class="ruby-identifier">ident</span>       = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:ident</span>       ]
  <span class="ruby-identifier">body_hash</span>   = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:body_hash</span>   ]
  <span class="ruby-identifier">query_hash</span>  = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:query_hash</span>  ]

  <span class="ruby-identifier">on_queue</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">on_queue?</span>

  <span class="ruby-comment"># Add a 404 error to the response (via a Proc for internal reuse).</span>

  <span class="ruby-identifier">add_404</span> = <span class="ruby-constant">Proc</span>.<span class="ruby-identifier">new</span> {
    <span class="ruby-identifier">hash</span> = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span><span class="ruby-operator">::</span><span class="ruby-constant">Endpoint</span><span class="ruby-operator">::</span><span class="ruby-constant">AugmentedHash</span>.<span class="ruby-identifier">new</span>
    <span class="ruby-identifier">hash</span>.<span class="ruby-identifier">platform_errors</span>.<span class="ruby-identifier">add_error</span>(
      <span class="ruby-string">&#39;platform.not_found&#39;</span>,
      <span class="ruby-string">&#39;reference&#39;</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:entity_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;v#{ options[ :version ] } of #{ options[ :resource ] } interface endpoint&quot;</span> }
    )
    <span class="ruby-identifier">hash</span>
  }

  <span class="ruby-comment"># No endpoint found? Yikes!</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">remote_info</span>.<span class="ruby-identifier">nil?</span> )
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">add_404</span>.<span class="ruby-identifier">call</span>()

  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">on_queue</span>
    <span class="ruby-identifier">alchemy_options</span> = {
      <span class="ruby-value">:session_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@session_id</span>,
      <span class="ruby-value">:host</span>       =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@rack_request</span>.<span class="ruby-identifier">host</span>,
      <span class="ruby-value">:port</span>       =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@rack_request</span>.<span class="ruby-identifier">port</span>
    }

  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">remote_uri</span>  = <span class="ruby-identifier">remote_info</span>.<span class="ruby-identifier">dup</span> <span class="ruby-comment"># Duplicate =&gt; avoid accidental modify-&quot;remote_info&quot;-by-reference via &quot;&lt;&lt;&quot; below</span>
    <span class="ruby-identifier">remote_uri</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;/#{ URI::escape( ident ) }&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Grey area over whether this encodes spaces as &quot;%20&quot; or &quot;+&quot;, but so</span>
  <span class="ruby-comment"># long as the middleware consistently uses the URI encode/decode calls,</span>
  <span class="ruby-comment"># it should work out in the end anyway.</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">query_hash</span> = <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">dup</span>
    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;search&#39;</span> ] = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">encode_www_form</span>( <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;search&#39;</span> ] ) <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;search&#39;</span> ].<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Hash</span> ) )
    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;filter&#39;</span> ] = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">encode_www_form</span>( <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;filter&#39;</span> ] ) <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;filter&#39;</span> ].<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Hash</span> ) )

    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ] = <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ].<span class="ruby-identifier">join</span>( <span class="ruby-string">&#39;,&#39;</span> ) <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ].<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Array</span> ) )
    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ] = <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ].<span class="ruby-identifier">join</span>( <span class="ruby-string">&#39;,&#39;</span> ) <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ].<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Array</span> ) )

    <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-string">&#39;search&#39;</span>     ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;search&#39;</span>     ].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;search&#39;</span>     ].<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-string">&#39;filter&#39;</span>     ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;filter&#39;</span>     ].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;filter&#39;</span>     ].<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-string">&#39;_embed&#39;</span>     ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ].<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-string">&#39;_reference&#39;</span> ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ].<span class="ruby-identifier">empty?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">on_queue</span>
      <span class="ruby-identifier">alchemy_options</span>[ <span class="ruby-value">:query</span> ] = <span class="ruby-identifier">query_hash</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">remote_uri</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&#39;?&#39;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">URI</span>.<span class="ruby-identifier">encode_www_form</span>( <span class="ruby-identifier">query_hash</span> )
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">body_data</span> = <span class="ruby-identifier">body_hash</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-string">&#39;&#39;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">body_hash</span>.<span class="ruby-identifier">to_json</span>
  <span class="ruby-identifier">headers</span>   = {
    <span class="ruby-string">&#39;Content-Type&#39;</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;application/json; charset=utf-8&#39;</span>,
    <span class="ruby-string">&#39;Content-Language&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@locale</span>,
    <span class="ruby-string">&#39;X-Interaction-ID&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@interaction_id</span>
  }

  <span class="ruby-identifier">headers</span>[ <span class="ruby-string">&#39;X-Session-ID&#39;</span> ] = <span class="ruby-ivar">@session_id</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@session_id</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-comment"># Use HTTP or Alchemy for the actual communications.</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">on_queue</span>

    <span class="ruby-comment"># Call via Alchemy.</span>

    <span class="ruby-keyword">unless</span> <span class="ruby-keyword">defined?</span>( <span class="ruby-identifier">@@alchemy</span> ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">@@alchemy</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&#39;Inter-resource call requested on queue, but no Alchemy endpoint was sent in the Rack environment&#39;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">alchemy_options</span>[ <span class="ruby-value">:body</span>    ] = <span class="ruby-identifier">body_data</span>
    <span class="ruby-identifier">alchemy_options</span>[ <span class="ruby-value">:headers</span> ] = <span class="ruby-identifier">headers</span>

    <span class="ruby-identifier">response</span> = <span class="ruby-identifier">@@alchemy</span>.<span class="ruby-identifier">http_request</span>(
      <span class="ruby-identifier">remote_info</span>[ <span class="ruby-value">:queue</span> ],
      <span class="ruby-identifier">http_method</span>,
      <span class="ruby-identifier">remote_info</span>[ <span class="ruby-value">:path</span> ],
      <span class="ruby-identifier">alchemy_options</span>
    )

  <span class="ruby-keyword">else</span>

    <span class="ruby-comment"># Drive Net::HTTP directly.</span>

    <span class="ruby-identifier">remote_uri</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">remote_uri</span> )
    <span class="ruby-identifier">http</span>       = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">remote_uri</span>.<span class="ruby-identifier">host</span>, <span class="ruby-identifier">remote_uri</span>.<span class="ruby-identifier">port</span> )

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">remote_uri</span>.<span class="ruby-identifier">scheme</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;https&quot;</span>
      <span class="ruby-identifier">http</span>.<span class="ruby-identifier">use_ssl</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-comment"># TODO: This is not so cool but want something going.</span>
      <span class="ruby-identifier">http</span>.<span class="ruby-identifier">verify_mode</span> = <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSL</span><span class="ruby-operator">::</span><span class="ruby-constant">VERIFY_NONE</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">request_class</span> = {
      <span class="ruby-string">&#39;POST&#39;</span>   =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Post</span>,
      <span class="ruby-string">&#39;PATCH&#39;</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Patch</span>,
      <span class="ruby-string">&#39;DELETE&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Delete</span>
    }[ <span class="ruby-identifier">http_method</span> ] <span class="ruby-operator">||</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Get</span>

    <span class="ruby-identifier">request</span>      = <span class="ruby-identifier">request_class</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">remote_uri</span>.<span class="ruby-identifier">request_uri</span>() )
    <span class="ruby-identifier">request</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">body_data</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">body_data</span>.<span class="ruby-identifier">empty?</span>

    <span class="ruby-identifier">request</span>.<span class="ruby-identifier">initialize_http_header</span>( <span class="ruby-identifier">headers</span> )

    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">response</span> = <span class="ruby-identifier">http</span>.<span class="ruby-identifier">request</span>( <span class="ruby-identifier">request</span> )
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNREFUSED</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">add_404</span>.<span class="ruby-identifier">call</span>()
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Parse the response (assumed valid JSON else #for_rack would have failed</span>
  <span class="ruby-comment"># when the originating response object was turned into the Rack response).</span>

  <span class="ruby-identifier">parsed</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>(
    <span class="ruby-identifier">response</span>.<span class="ruby-identifier">body</span>,
    <span class="ruby-value">:object_class</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span><span class="ruby-operator">::</span><span class="ruby-constant">Endpoint</span><span class="ruby-operator">::</span><span class="ruby-constant">AugmentedHash</span>,
    <span class="ruby-value">:array_class</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span><span class="ruby-operator">::</span><span class="ruby-constant">Endpoint</span><span class="ruby-operator">::</span><span class="ruby-constant">AugmentedArray</span>
  )

  <span class="ruby-comment"># Just in case someone changes JSON parsers under us and the replacement</span>
  <span class="ruby-comment"># doesn&#39;t support the options used above...</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">parsed</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span><span class="ruby-operator">::</span><span class="ruby-constant">Endpoint</span><span class="ruby-operator">::</span><span class="ruby-constant">AugmentedHash</span> )
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Hoodoo::Services::Middleware: Incompatible JSON implementation in use which doesn&#39;t understand &#39;object_class&#39; or &#39;array_class&#39; options&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># If the parsed data wrapped an array, extract just the array part, else</span>
  <span class="ruby-comment"># the hash part.</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">parsed</span>[ <span class="ruby-string">&#39;_data&#39;</span> ].<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Array</span> ) )
    <span class="ruby-identifier">parsed</span> = <span class="ruby-identifier">parsed</span>[ <span class="ruby-string">&#39;_data&#39;</span> ]

  <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">parsed</span>[ <span class="ruby-string">&#39;kind&#39;</span> ] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;Errors&#39;</span> )

    <span class="ruby-comment"># This isn&#39;t an array, it&#39;s an AugmentedHash describing errors. Turn</span>
    <span class="ruby-comment"># this into a formal errors collection.</span>

    <span class="ruby-identifier">errors_from_other_resource</span> = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Errors</span>.<span class="ruby-identifier">new</span>()

    <span class="ruby-identifier">parsed</span>[ <span class="ruby-string">&#39;errors&#39;</span> ].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">error</span> <span class="ruby-operator">|</span>
      <span class="ruby-identifier">errors_from_other_resource</span>.<span class="ruby-identifier">add_precompiled_error</span>(
        <span class="ruby-identifier">error</span>[ <span class="ruby-string">&#39;code&#39;</span>      ],
        <span class="ruby-identifier">error</span>[ <span class="ruby-string">&#39;message&#39;</span>   ],
        <span class="ruby-identifier">error</span>[ <span class="ruby-string">&#39;reference&#39;</span> ],
        <span class="ruby-identifier">response</span>.<span class="ruby-identifier">code</span>
      )
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">parsed</span>.<span class="ruby-identifier">set_platform_errors</span>(
      <span class="ruby-identifier">translate_errors_from_other_resource</span>( <span class="ruby-identifier">errors_from_other_resource</span> )
    )
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">parsed</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-local_service_for">
            
              <b>local_service_for</b>( resource, version = 1 )
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-i-local_service_for" name="method-i-local_service_for" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Is the given resource available as a local endpoint in this service
application?</p>
<dl class="rdoc-list note-list"><dt>resource
<dd>
<p>Resource name of interest, e.g. <code>:Purchase</code>. String or symbol.</p>
</dd><dt><code>version</code>
<dd>
<p>Version of interface required as an Integer. Optional - default is 1.</p>
</dd></dl>

<p>Returns an @@services entry (see implementation of initialize) if local,
else <code>nil</code>.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-local_service_for_source')" id="l_method-i-local_service_for_source">show</a>
                
              </p>
              <div id="method-i-local_service_for_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 1624</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">local_service_for</span>( <span class="ruby-identifier">resource</span>, <span class="ruby-identifier">version</span> = <span class="ruby-number">1</span> )
  <span class="ruby-identifier">resource</span> = <span class="ruby-identifier">resource</span>.<span class="ruby-identifier">to_sym</span>
  <span class="ruby-identifier">version</span>  = <span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_i</span>

  <span class="ruby-identifier">@@services</span>.<span class="ruby-identifier">find</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">entry</span> <span class="ruby-operator">|</span>
    <span class="ruby-identifier">interface</span> = <span class="ruby-identifier">entry</span>[ <span class="ruby-value">:interface</span> ]
    <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">resource</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">resource</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">version</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-remote_service_for">
            
              <b>remote_service_for</b>( resource, version = 1 )
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-i-remote_service_for" name="method-i-remote_service_for" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Is the given resource available as a remote endpoint we can target via
HTTP?</p>
<dl class="rdoc-list note-list"><dt>resource
<dd>
<p>Resource name of interest, e.g. <code>:Purchase</code>. String or symbol.</p>
</dd><dt><code>version</code>
<dd>
<p>Version of interface required as an Integer. Optional - default is 1.</p>
</dd></dl>

<p>Returns:</p>
<ul><li>
<p><code>nil</code> if the endpoint is not found.</p>
</li><li>
<p>URI as a string if an endpoint is found and we are <em>not</em> running on
an AMQP/Alchemy based architecture (see <a
href="Middleware.html#method-c-on_queue-3F">::on_queue?</a>).</p>
</li><li>
<p>If an endpoint is found and we <em>are</em> running on an AMQP/Alchemy
based architecture (see <a
href="Middleware.html#method-c-on_queue-3F">::on_queue?</a>), this is a
Hash with keys <code>:queue</code> (value is the AMQP queue name) and
<code>path</code> (the equivalent URI path that would be used, were this an
HTTP request).</p>
</li></ul>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-remote_service_for_source')" id="l_method-i-remote_service_for_source">show</a>
                
              </p>
              <div id="method-i-remote_service_for_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 1655</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">remote_service_for</span>( <span class="ruby-identifier">resource</span>, <span class="ruby-identifier">version</span> = <span class="ruby-number">1</span> )

  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">on_queue?</span>

    <span class="ruby-identifier">v</span> = <span class="ruby-node">&quot;/v#{ version }/&quot;</span>

    <span class="ruby-comment"># Static mapping until service discovery is sorted. Yes, this Hash gets</span>
    <span class="ruby-comment"># computed at run-time for every call. It&#39;s a temporary stopgap.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-keyword">return</span> {

      <span class="ruby-string">&#39;Health&#39;</span>      =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.utility&#39;</span>,   <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;health&#39;</span>       },
      <span class="ruby-string">&#39;Version&#39;</span>     =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.utility&#39;</span>,   <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;version&#39;</span>      },

      <span class="ruby-string">&#39;Log&#39;</span>         =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.logging&#39;</span>,   <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;logs&#39;</span>         },
      <span class="ruby-string">&#39;Errors&#39;</span>      =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.logging&#39;</span>,   <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;errors&#39;</span>       },
      <span class="ruby-string">&#39;Statistic&#39;</span>   =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.logging&#39;</span>,   <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;statistics&#39;</span>   },

      <span class="ruby-string">&#39;Account&#39;</span>     =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.member&#39;</span>,    <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;accounts&#39;</span>     },
      <span class="ruby-string">&#39;Member&#39;</span>      =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.member&#39;</span>,    <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;members&#39;</span>      },
      <span class="ruby-string">&#39;Membership&#39;</span>  =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.member&#39;</span>,    <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;memberships&#39;</span>  },
      <span class="ruby-string">&#39;Token&#39;</span>       =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.member&#39;</span>,    <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;tokens&#39;</span>       },

      <span class="ruby-string">&#39;Participant&#39;</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.programme&#39;</span>, <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;participants&#39;</span> },
      <span class="ruby-string">&#39;Outlet&#39;</span>      =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.programme&#39;</span>, <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;outlets&#39;</span>      },
      <span class="ruby-string">&#39;Involvement&#39;</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.programme&#39;</span>, <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;involvements&#39;</span> },
      <span class="ruby-string">&#39;Programme&#39;</span>   =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.programme&#39;</span>, <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;programmes&#39;</span>   },

      <span class="ruby-string">&#39;Balance&#39;</span>     =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.financial&#39;</span>, <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;balances&#39;</span>     },
      <span class="ruby-string">&#39;Currency&#39;</span>    =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.financial&#39;</span>, <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;currencies&#39;</span>   },
      <span class="ruby-string">&#39;Voucher&#39;</span>     =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.financial&#39;</span>, <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;vouchers&#39;</span>     },
      <span class="ruby-string">&#39;Calculation&#39;</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.financial&#39;</span>, <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;calculations&#39;</span> },
      <span class="ruby-string">&#39;Transaction&#39;</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.financial&#39;</span>, <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;transactions&#39;</span> },

      <span class="ruby-string">&#39;Purchase&#39;</span>    =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:queue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;service.purchase&#39;</span>,  <span class="ruby-value">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;purchases&#39;</span>    },

    }[ <span class="ruby-identifier">resource</span>.<span class="ruby-identifier">to_s</span> ]

  <span class="ruby-keyword">else</span>

    <span class="ruby-keyword">return</span> <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">@@drb_service</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">resource</span>, <span class="ruby-identifier">version</span> )
    <span class="ruby-keyword">rescue</span>
      <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-translate_errors_from_other_resource">
            
              <b>translate_errors_from_other_resource</b>( errors )
            
            <a href="../../../classes/Hoodoo/Services/Middleware.html#method-i-translate_errors_from_other_resource" name="method-i-translate_errors_from_other_resource" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Take an <a href="../Errors.html">Hoodoo::Errors</a> instance constructed
from, or obtained via a call to another service (inter-resource local or
remote call) and translate the contents to make sense when those errors are
reported in the context of an outer resource&#39;s response to a request.</p>

<p>For example, if one resource tries to look up a reference to another as
part of a <code>show</code> action, but that <em>referred</em> resource is
not found, internally that would be reported via HTTP 404. This would
confuse callers if returned verbatim as it implies the target, outermost
resource wasn&#39;t found, even though it was. Instead, the 404 is turned
into a 422 with code/message/reference data describing the equivalent
“inner reference not found” condition.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-translate_errors_from_other_resource_source')" id="l_method-i-translate_errors_from_other_resource_source">show</a>
                
              </p>
              <div id="method-i-translate_errors_from_other_resource_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/hoodoo/services/middleware/middleware.rb, line 2079</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">translate_errors_from_other_resource</span>( <span class="ruby-identifier">errors</span> )
  <span class="ruby-comment"># TODO - lots of testing; e.g. c.f. nested basket items accumulating</span>
  <span class="ruby-comment"># a bunch of 404s for products which weren&#39;t found via a complex path.</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">errors</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>

    </div>
  </body>
</html>    