<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>ApiTools::ServiceMiddleware</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/github.css" type="text/css" media="screen" />
<script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            <span class="type">Class</span> 
            ApiTools::ServiceMiddleware 
            
                <span class="parent">&lt; 
                    
                    Object
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/api_tools/service_middleware/amqp_log_message_rb.html">lib/api_tools/service_middleware/amqp_log_message.rb</a></li>
            
            <li><a href="../../files/lib/api_tools/service_middleware/service_endpoint_rb.html">lib/api_tools/service_middleware/service_endpoint.rb</a></li>
            
            <li><a href="../../files/lib/api_tools/service_middleware/service_middleware_rb.html">lib/api_tools/service_middleware/service_middleware.rb</a></li>
            
            <li><a href="../../files/lib/api_tools/service_middleware/service_registry_drb_server_rb.html">lib/api_tools/service_middleware/service_registry_drb_server.rb</a></li>
            
            <li><a href="../../files/lib/api_tools/service_middleware/structured_logger_rb.html">lib/api_tools/service_middleware/structured_logger.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>Rack middleware, declared in (e.g.) a <code>config.ru</code> file in the
usual way:</p>

<pre><code>use( ApiTools::ServiceMiddleware )</code></pre>

<p>This is the core of the common service implementation on the Rack
client-request-handling side. It is run in the context of an <a
href="ServiceApplication.html">ApiTools::ServiceApplication</a> subclass
that&#39;s been given to Rack as the Rack endpoint application; it looks at
the component interfaces supported by the service and routes requests to
the correct one (or raises a 404).</p>

<p>Lots of preprocessing and postprocessing gets done to set up things like
locale information, enforce content types and so-forth. Request data is
assembled in a parsed, structured format for passing to service
implementations and a response object built so that services have a
consistent way to return results, which can be post-processed further by
the middleware before returning the data to Rack.</p>

<p>The middleware supports structured logging - see <a
href="Logger.html#method-c-report">ApiTools::Logger.report</a>. Its own log
data uses component <code>Middleware</code>. It will also log essential
data for successful and failed interactions with resource endpoints using
the resource name as the component. In such cases, the codes it uses are
always prefixed by <code>middleware_</code> and service applications should
consider codes with this prefix reserved - do not use such codes yourself.</p>

    </div>
  


  


  
  


  
    <!-- Namespace -->
    <div class="sectiontitle">Namespace</div>
    <ul>
      
        <li>
          <span class="type">CLASS</span>
          <a href="ServiceMiddleware/AMQPLogMessage.html">ApiTools::ServiceMiddleware::AMQPLogMessage</a>
        </li>
      
        <li>
          <span class="type">CLASS</span>
          <a href="ServiceMiddleware/ServiceEndpoint.html">ApiTools::ServiceMiddleware::ServiceEndpoint</a>
        </li>
      
        <li>
          <span class="type">CLASS</span>
          <a href="ServiceMiddleware/ServiceRegistryDRbServer.html">ApiTools::ServiceMiddleware::ServiceRegistryDRbServer</a>
        </li>
      
        <li>
          <span class="type">CLASS</span>
          <a href="ServiceMiddleware/StructuredLogger.html">ApiTools::ServiceMiddleware::StructuredLogger</a>
        </li>
      
    </ul>
  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-call">call</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>E</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-environment">environment</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>H</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-has_memcache-3F">has_memcache?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-inter_service">inter_service</a>,
              </li>
            
              
              <li>
                <a href="#method-i-inter_service_local">inter_service_local</a>,
              </li>
            
              
              <li>
                <a href="#method-i-inter_service_remote">inter_service_remote</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-local_service_for">local_service_for</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-new">new</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>O</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-on_queue-3F">on_queue?</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>R</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-record_host_and_port">record_host_and_port</a>,
              </li>
            
              
              <li>
                <a href="#method-i-remote_service_for">remote_service_for</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    
      <!-- Section constants -->
      <div class="sectiontitle">Constants</div>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class="attr-name">ALLOWED_ACTIONS</td>
            <td>=</td>
            <td class="attr-value">[
:list,
:show,
:create,
:update,
:delete,
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>All allowed action names in implementations, used for internal checks. This
is also the default supported set of actions. Symbols.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ALLOWED_QUERIES_LIST</td>
            <td>=</td>
            <td class="attr-value">[
&#39;offset&#39;,
&#39;limit&#39;,
&#39;sort&#39;,
&#39;direction&#39;,
&#39;search&#39;,
&#39;filter&#39;
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Allowed common fields in query strings (list actions only). Strings.</p>

<p>Only ever <strong>add</strong> to this list. As the API evolves, legacy
clients will be calling with previously documented query strings and
removing any entries from the list below could cause their requests to be
rejected with a &#39;platform.malformed&#39; error.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">ALLOWED_QUERIES_ALL</td>
            <td>=</td>
            <td class="attr-value">[
&#39;_embed&#39;,
&#39;_reference&#39;
]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Allowed common fields in query strings (all actions). Strings. Adds to the
::ALLOWED_QUERIES_LIST for list actions.</p>

<p>Only ever <strong>add</strong> to this list. As the API evolves, legacy
clients will be calling with previously documented query strings and
removing any entries from the list below could cause their requests to be
rejected with a &#39;platform.malformed&#39; error.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">SUPPORTED_MEDIA_TYPES</td>
            <td>=</td>
            <td class="attr-value">[ &#39;application/json&#39; ]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Allowed media types in Content-Type headers.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">SUPPORTED_ENCODINGS</td>
            <td>=</td>
            <td class="attr-value">[ &#39;utf-8&#39; ]</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Allowed (required) charsets in Content-Type headers.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">MAXIMUM_PAYLOAD_SIZE</td>
            <td>=</td>
            <td class="attr-value">1048576</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Somewhat arbitrary maximum incoming payload size to prevent ham-fisted DOS
attempts to consume RAM.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">MAXIMUM_LOGGED_PAYLOAD_SIZE</td>
            <td>=</td>
            <td class="attr-value">1024</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Maximum <strong>logged</strong> payload size.</p></td>
            </tr>
          
        
          <tr valign='top'>
            <td class="attr-name">FRONT_OBJECT</td>
            <td>=</td>
            <td class="attr-value">ApiTools::ServiceMiddleware::ServiceRegistryDRbServer.new</td>
          </tr>
          
            <tr valign='top'>
              <td>&nbsp;</td>
              <td colspan="2" class="attr-desc"><p>Singleton “Front object” for the DRB service used in local development.</p></td>
            </tr>
          
        
      </table>
    


    


    <!-- Methods -->
    
      <div class="sectiontitle">Class Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-c-environment">
            
              <b>environment</b>()
            
            <a href="../../classes/ApiTools/ServiceMiddleware.html#method-c-environment" name="method-c-environment" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Utility - returns the execution environment as a Rails-like environment
object which answers queries like <code>production?</code> or
<code>staging?</code> with <code>true</code> or <code>false</code>
according to the <code>RACK_ENV</code> environment variable setting.</p>

<p>Example:</p>

<pre><code>if ApiTools::ServiceMiddleware.environment.production?
  # ...do something only if RACK_ENV=&quot;production&quot;
end</code></pre>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-environment_source')" id="l_method-c-environment_source">show</a>
                
              </p>
              <div id="method-c-environment_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/service_middleware/service_middleware.rb, line 115</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">self</span>.<span class="ruby-identifier">environment</span>
  <span class="ruby-ivar">@_env</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">ApiTools</span><span class="ruby-operator">::</span><span class="ruby-constant">StringInquirer</span>.<span class="ruby-identifier">new</span>( <span class="ruby-constant">ENV</span>[ <span class="ruby-string">&#39;RACK_ENV&#39;</span> ] <span class="ruby-operator">||</span> <span class="ruby-string">&#39;development&#39;</span> )
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-has_memcache-3F">
            
              <b>has_memcache?</b>()
            
            <a href="../../classes/ApiTools/ServiceMiddleware.html#method-c-has_memcache-3F" name="method-c-has_memcache-3F" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Do we have Memcache available? If not, assume local development with higher
level queue services not available. Most service authors should not ever
need to check this.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-has_memcache-3F_source')" id="l_method-c-has_memcache-3F_source">show</a>
                
              </p>
              <div id="method-c-has_memcache-3F_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/service_middleware/service_middleware.rb, line 123</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">self</span>.<span class="ruby-identifier">has_memcache?</span>
  <span class="ruby-identifier">m</span> = <span class="ruby-constant">ENV</span>[ <span class="ruby-string">&#39;MEMCACHE_URL&#39;</span> ]
  <span class="ruby-identifier">m</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-new">
            
              <b>new</b>( app )
            
            <a href="../../classes/ApiTools/ServiceMiddleware.html#method-c-new" name="method-c-new" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Initialize the middleware instance.</p>

<p><code>app</code> Rack app instance to which calls should be passed.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/service_middleware/service_middleware.rb, line 151</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">initialize</span>( <span class="ruby-identifier">app</span> )

  <span class="ruby-ivar">@service_container</span> = <span class="ruby-identifier">app</span>

  <span class="ruby-keyword">if</span> <span class="ruby-keyword">defined?</span>( <span class="ruby-constant">NewRelic</span> ) <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-keyword">defined?</span>( <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span> ) <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-keyword">defined?</span>( <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">Instrumentation</span> ) <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-keyword">defined?</span>( <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">Instrumentation</span><span class="ruby-operator">::</span><span class="ruby-constant">MiddlewareProxy</span> ) <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-ivar">@service_container</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">Instrumentation</span><span class="ruby-operator">::</span><span class="ruby-constant">MiddlewareProxy</span> )

    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@service_container</span>.<span class="ruby-identifier">respond_to?</span>( <span class="ruby-value">:target</span> )
      <span class="ruby-ivar">@newrelic_wrapper</span>  = <span class="ruby-ivar">@service_container</span>
      <span class="ruby-ivar">@service_container</span> = <span class="ruby-ivar">@service_container</span>.<span class="ruby-identifier">target</span>()
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;ApiTools::ServiceMiddleware instance created with NewRelic-wrapped ServiceApplication entity, but NewRelic API is not as expected by ApiTools; incompatible NewRelic version.&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@service_container</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-constant">ApiTools</span><span class="ruby-operator">::</span><span class="ruby-constant">ServiceApplication</span> )
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;ApiTools::ServiceMiddleware instance created with non-ServiceApplication entity of class &#39;#{ @service_container.class }&#39; - is this the last middleware in the chain via &#39;use()&#39; and is Rack &#39;run()&#39;-ing the correct thing?&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Collect together the implementation instances and the matching regexps</span>
  <span class="ruby-comment"># for endpoints. An array of hashes.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># Key              Value</span>
  <span class="ruby-comment"># =======================================================================</span>
  <span class="ruby-comment"># regexp           Regexp for +String#match+ on the URI path component</span>
  <span class="ruby-comment"># interface        ApiTools::ServiceInterface subclass associated with</span>
  <span class="ruby-comment">#                  the endpoint regular expression in +regexp+</span>
  <span class="ruby-comment"># actions          Array of symbols naming allowed actions</span>
  <span class="ruby-comment"># implementation   ApiTools::ServiceImplementation subclass *instance* to</span>
  <span class="ruby-comment">#                  use on match</span>

  <span class="ruby-ivar">@services</span> = <span class="ruby-ivar">@service_container</span>.<span class="ruby-identifier">component_interfaces</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">interface</span> <span class="ruby-operator">|</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">endpoint</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">implementation</span>.<span class="ruby-identifier">nil?</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;ApiTools::ServiceMiddleware encountered invalid interface class #{ interface } via service class #{ @service_container.class }&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Regexp explanation:</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># Match &quot;/&quot;, the version text, &quot;/&quot;, the endpoint text, then either</span>
    <span class="ruby-comment"># another &quot;/&quot;, a &quot;.&quot; or the end of the string, followed by capturing</span>
    <span class="ruby-comment"># everything else. Match data index 1 will be whatever character (if</span>
    <span class="ruby-comment"># any) followed after the endpoint (&quot;/&quot; or &quot;.&quot;) while index 2 contains</span>
    <span class="ruby-comment"># everything else.</span>

    {
      <span class="ruby-value">:regexp</span>         =<span class="ruby-operator">&gt;</span> <span class="ruby-node">/\/v#{ interface.version }\/#{ interface.endpoint }(\.|\/|$)(.*)/</span>,
      <span class="ruby-value">:path</span>           =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;/v#{ interface.version }/#{ interface.endpoint }&quot;</span>,
      <span class="ruby-value">:interface</span>      =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">interface</span>,
      <span class="ruby-value">:implementation</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">implementation</span>.<span class="ruby-identifier">new</span>
    }

  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">announce_presence_of</span>( <span class="ruby-ivar">@services</span> )
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-on_queue-3F">
            
              <b>on_queue?</b>()
            
            <a href="../../classes/ApiTools/ServiceMiddleware.html#method-c-on_queue-3F" name="method-c-on_queue-3F" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Are we running on the queue, else (implied) a local HTTP server?</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-on_queue-3F_source')" id="l_method-c-on_queue-3F_source">show</a>
                
              </p>
              <div id="method-c-on_queue-3F_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/service_middleware/service_middleware.rb, line 130</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">self</span>.<span class="ruby-identifier">on_queue?</span>
  <span class="ruby-identifier">q</span> = <span class="ruby-constant">ENV</span>[ <span class="ruby-string">&#39;AMQ_ENDPOINT&#39;</span> ]
  <span class="ruby-identifier">q</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">q</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-c-record_host_and_port">
            
              <b>record_host_and_port</b>( options = {} )
            
            <a href="../../classes/ApiTools/ServiceMiddleware.html#method-c-record_host_and_port" name="method-c-record_host_and_port" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Record internally the HTTP host and port during local development via e.g
<code>rackup</code> or testing with rspec. This is usually not called
directly except via the Rack startup monkey patch code in
<code>rack_monkey_patch.rb</code>.</p>

<p>Options hash <code>:Host</code> and <code>:Port</code> entries are
recorded.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-record_host_and_port_source')" id="l_method-c-record_host_and_port_source">show</a>
                
              </p>
              <div id="method-c-record_host_and_port_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/service_middleware/service_middleware.rb, line 142</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">self</span>.<span class="ruby-identifier">record_host_and_port</span>( <span class="ruby-identifier">options</span> = {} )
  <span class="ruby-identifier">@@recorded_host</span> = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:Host</span> ]
  <span class="ruby-identifier">@@recorded_port</span> = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:Port</span> ]
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                  
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-call">
            
              <b>call</b>( env )
            
            <a href="../../classes/ApiTools/ServiceMiddleware.html#method-i-call" name="method-i-call" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Run a Rack request, returning the [status, headers, body-array] data as per
the Rack protocol requirements.</p>

<p><code>env</code> Rack environment.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-call_source')" id="l_method-i-call_source">show</a>
                
              </p>
              <div id="method-i-call_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/service_middleware/service_middleware.rb, line 216</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">call</span>( <span class="ruby-identifier">env</span> )

  <span class="ruby-comment"># Global exception handler - catch problems in service implementations</span>
  <span class="ruby-comment"># and send back a 500 response as per API documentation (if possible).</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-keyword">begin</span>

    <span class="ruby-ivar">@interaction_id</span> = <span class="ruby-ivar">@session_id</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-ivar">@rack_request</span>   = <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Request</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">env</span> )

    <span class="ruby-comment"># If running on Alchemy / an AMQP based architecture, it&#39;ll have</span>
    <span class="ruby-comment"># forwarded details of the AMQEndpoint gem&#39;s queue service via the</span>
    <span class="ruby-comment"># Rack environment. Send this to the structured logger so it can do</span>
    <span class="ruby-comment"># queue-based structured logging via the provided service.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-constant">ApiTools</span><span class="ruby-operator">::</span><span class="ruby-constant">ServiceMiddleware</span><span class="ruby-operator">::</span><span class="ruby-constant">StructuredLogger</span>.<span class="ruby-identifier">alchemy</span> = <span class="ruby-identifier">env</span>[ <span class="ruby-string">&#39;rack.alchemy&#39;</span> ]

    <span class="ruby-comment"># Don&#39;t spew debug logs in non-test-like environments.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-identifier">env</span> = <span class="ruby-constant">ApiTools</span><span class="ruby-operator">::</span><span class="ruby-constant">ServiceMiddleware</span>.<span class="ruby-identifier">environment</span>()
    <span class="ruby-constant">ApiTools</span><span class="ruby-operator">::</span><span class="ruby-constant">Logger</span>.<span class="ruby-identifier">level</span> = <span class="ruby-value">:info</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">env</span>.<span class="ruby-identifier">test?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">env</span>.<span class="ruby-identifier">development?</span>

    <span class="ruby-identifier">debug_log</span>()

    <span class="ruby-ivar">@service_response</span> = <span class="ruby-constant">ApiTools</span><span class="ruby-operator">::</span><span class="ruby-constant">ServiceResponse</span>.<span class="ruby-identifier">new</span>

    <span class="ruby-identifier">preprocess</span>()
    <span class="ruby-identifier">process</span>()     <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@service_response</span>.<span class="ruby-identifier">halt_processing?</span>
    <span class="ruby-identifier">postprocess</span>() <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@service_response</span>.<span class="ruby-identifier">halt_processing?</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">respond_with</span>( <span class="ruby-ivar">@service_response</span>.<span class="ruby-identifier">for_rack</span>() )

  <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exception</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">respond_with</span>( <span class="ruby-identifier">record_exception</span>( <span class="ruby-ivar">@service_response</span>, <span class="ruby-identifier">exception</span> ) )

    <span class="ruby-keyword">rescue</span>

      <span class="ruby-keyword">begin</span>
        <span class="ruby-constant">ApiTools</span><span class="ruby-operator">::</span><span class="ruby-constant">Logger</span>.<span class="ruby-identifier">error</span>(
          <span class="ruby-string">&#39;ApiTools::ServiceMiddleware#call&#39;</span>,
          <span class="ruby-string">&#39;Middleware exception in exception handler&#39;</span>,
          <span class="ruby-identifier">exception</span>.<span class="ruby-identifier">to_s</span>
        )
      <span class="ruby-keyword">rescue</span>
        <span class="ruby-comment"># Ignore logger exceptions. Can&#39;t do anything about them. Just</span>
        <span class="ruby-comment"># try and get the response back to the client now.</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># An exception in the exception handler! Oh dear.</span>
      <span class="ruby-comment">#</span>
      <span class="ruby-identifier">rack_response</span> = <span class="ruby-constant">Rack</span><span class="ruby-operator">::</span><span class="ruby-constant">Response</span>.<span class="ruby-identifier">new</span>
      <span class="ruby-identifier">rack_response</span>.<span class="ruby-identifier">status</span> = <span class="ruby-number">500</span>
      <span class="ruby-identifier">rack_response</span>.<span class="ruby-identifier">write</span>( <span class="ruby-string">&#39;Middleware exception in exception handler&#39;</span> )
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">rack_response</span>.<span class="ruby-identifier">finish</span>

    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
              
      <div class="sectiontitle">Instance Protected methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-inter_service">
            
              <b>inter_service</b>( options )
            
            <a href="../../classes/ApiTools/ServiceMiddleware.html#method-i-inter_service" name="method-i-inter_service" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Perform an inter-service call. This shouldn&#39;t be called directly; call
via the <a
href="ServiceMiddleware/ServiceEndpoint.html">ApiTools::ServiceMiddleware::ServiceEndpoint</a>
subclass specialised methods instead, which makes sure it sets up the
required parameters in correct combinations. Undefined results will arise
for incorrect calls.</p>
<dl class="rdoc-list note-list"><dt><code>options</code>
<dd>
<p>Options hash with keys and required values described below.</p>
</dd></dl>

<p>Options are as follows - keys must be Symbols:</p>
<dl class="rdoc-list note-list"><dt><code>local</code>
<dd>
<p>A +@services+ entry (see implementation of initialize) describing the
service to call if local, else <code>nil</code> or absent.</p>
</dd><dt><code>remote</code>
<dd>
<p>A URI as a String for a remote service endpoint, else <code>nil</code> or
absent.</p>
</dd><dt><code>resource</code>
<dd>
<p>The String or Symbol resource name, e.g. “Product”.</p>
</dd><dt><code>version</code>
<dd>
<p>The Integer endpoint API version, e.g. 2.</p>
</dd><dt><code>http_method</code>
<dd>
<p>HTTP method as a String, e.g. “<code>GET</code>”, “<code>DELETE</code>”.</p>
</dd><dt><code>ident</code>
<dd>
<p>ID / <a href="UUID.html">UUID</a> / similar; first and only path component.</p>
</dd><dt><code>query_hash</code>
<dd>
<p>Converted to query string.</p>
</dd><dt><code>body_hash</code>
<dd>
<p>Converted to body data.</p>
</dd></dl>

<p>Parameters should be nil where the value would not be allowed given the
HTTP method. HTTP methods must map to understood actions.</p>

<p>@service_response is updated on exit. If this says “halt processing”,
errors were generated. Ignore the function return value. Otherwise, returns
a Has equivalent of the JSON resource representation in the non-list-action
cases, else an array of zero or more JSON resource representations in the
list action case.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-inter_service_source')" id="l_method-i-inter_service_source">show</a>
                
              </p>
              <div id="method-i-inter_service_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/service_middleware/service_middleware.rb, line 1307</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">inter_service</span>( <span class="ruby-identifier">options</span> )

  <span class="ruby-identifier">remote</span> = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:local</span> ].<span class="ruby-identifier">nil?</span>

  <span class="ruby-identifier">debug_log</span>( <span class="ruby-node">&quot;#{ remote ? &#39;Remote&#39; : &#39;Local&#39; } inter-service call requested with options #{ options }&quot;</span> )

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">remote</span> )
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">inter_service_remote</span>( <span class="ruby-identifier">options</span> )
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">inter_service_local</span>( <span class="ruby-identifier">options</span> )
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@service_response</span>.<span class="ruby-identifier">halt_processing?</span>
    <span class="ruby-identifier">debug_log</span>( <span class="ruby-node">&quot;#{ remote ? &#39;Remote&#39; : &#39;Local&#39; } inter-service call halted processing with errors #{ @service_response.errors.errors }&quot;</span> )
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">debug_log</span>( <span class="ruby-node">&quot;#{ remote ? &#39;Remote&#39; : &#39;Local&#39; } inter-service call succeeded with result &#39;#{ result }&#39;&quot;</span> )
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-inter_service_local">
            
              <b>inter_service_local</b>( options )
            
            <a href="../../classes/ApiTools/ServiceMiddleware.html#method-i-inter_service_local" name="method-i-inter_service_local" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Make a local (non-HTTP local Ruby method call) inter-service call. Fast.</p>
<dl class="rdoc-list note-list"><dt>options
<dd>
<p>See <a
href="ServiceMiddleware.html#method-i-inter_service">inter_service</a>.</p>
</dd><dt>Returns
<dd>
<p>See <a
href="ServiceMiddleware.html#method-i-inter_service">inter_service</a>.</p>
</dd></dl>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-inter_service_local_source')" id="l_method-i-inter_service_local_source">show</a>
                
              </p>
              <div id="method-i-inter_service_local_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/service_middleware/service_middleware.rb, line 1475</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">inter_service_local</span>( <span class="ruby-identifier">options</span> )
  <span class="ruby-identifier">service</span>        = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:local</span>       ]
  <span class="ruby-identifier">http_method</span>    = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:http_method</span> ]
  <span class="ruby-identifier">ident</span>          = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:ident</span>       ]
  <span class="ruby-identifier">body_hash</span>      = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:body_hash</span>   ]
  <span class="ruby-identifier">query_hash</span>     = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:query_hash</span>  ]

  <span class="ruby-identifier">interface</span>      = <span class="ruby-identifier">service</span>[ <span class="ruby-value">:interface</span>      ]
  <span class="ruby-identifier">actions</span>        = <span class="ruby-identifier">service</span>[ <span class="ruby-value">:actions</span>        ]
  <span class="ruby-identifier">implementation</span> = <span class="ruby-identifier">service</span>[ <span class="ruby-value">:implementation</span> ]

  <span class="ruby-comment"># We must construct a call context for the local service. This means</span>
  <span class="ruby-comment"># a local request object which we fill in with data just as if we&#39;d</span>
  <span class="ruby-comment"># parsed an inbound HTTP request and a response object that contains</span>
  <span class="ruby-comment"># the usual default data.</span>

  <span class="ruby-identifier">local_service_response</span> = <span class="ruby-constant">ApiTools</span><span class="ruby-operator">::</span><span class="ruby-constant">ServiceResponse</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">set_common_response_headers</span>( <span class="ruby-identifier">local_service_response</span> )
  <span class="ruby-identifier">update_service_response_for</span>( <span class="ruby-identifier">local_service_response</span>, <span class="ruby-identifier">interface</span> )

  <span class="ruby-identifier">upc</span>  = []
  <span class="ruby-identifier">upc</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ident</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">empty?</span>

  <span class="ruby-identifier">action</span> = <span class="ruby-identifier">determine_action</span>(
    <span class="ruby-identifier">interface</span>,
    <span class="ruby-identifier">http_method</span>,
    <span class="ruby-identifier">upc</span>.<span class="ruby-identifier">empty?</span>,
    <span class="ruby-identifier">local_service_response</span>
  )

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">local_service_response</span>.<span class="ruby-identifier">halt_processing?</span>
    <span class="ruby-ivar">@service_response</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">merge!</span>( <span class="ruby-identifier">local_service_response</span>.<span class="ruby-identifier">errors</span> )
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">local_service_request</span>                     = <span class="ruby-identifier">new_service_request_for</span>( <span class="ruby-identifier">interface</span> )
  <span class="ruby-identifier">local_service_request</span>.<span class="ruby-identifier">uri_path_components</span> = <span class="ruby-identifier">upc</span>
  <span class="ruby-identifier">local_service_request</span>.<span class="ruby-identifier">uri_path_extension</span>  = <span class="ruby-string">&#39;&#39;</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">query_hash</span> = <span class="ruby-constant">ApiTools</span><span class="ruby-operator">::</span><span class="ruby-constant">Utilities</span>.<span class="ruby-identifier">stringify</span>( <span class="ruby-identifier">query_hash</span> )

    <span class="ruby-comment"># This is for inter-service local calls where a service author</span>
    <span class="ruby-comment"># specifies &quot;:_embed =&gt; &#39;foo&#39;&quot; accidentally, forgetting that it</span>
    <span class="ruby-comment"># should be a single element array. It&#39;s such a common mistake</span>
    <span class="ruby-comment"># that we tolerate it here. Same for &quot;_reference&quot;.</span>

    <span class="ruby-identifier">data</span> = <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span> ]
    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span> ] = [ <span class="ruby-identifier">data</span> ] <span class="ruby-keyword">if</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">String</span> ) <span class="ruby-operator">||</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Symbol</span> )

    <span class="ruby-identifier">data</span> = <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ]
    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ] = [ <span class="ruby-identifier">data</span> ] <span class="ruby-keyword">if</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">String</span> ) <span class="ruby-operator">||</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Symbol</span> )

    <span class="ruby-comment"># Regardless, make sure embed/reference array data contains strings.</span>

    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ].<span class="ruby-identifier">map!</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_s</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ].<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ].<span class="ruby-identifier">map!</span>( <span class="ruby-operator">&amp;</span><span class="ruby-value">:to_s</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ].<span class="ruby-identifier">nil?</span>

    <span class="ruby-identifier">process_query_hash</span>(
      <span class="ruby-identifier">action</span>,
      <span class="ruby-identifier">query_hash</span>,
      <span class="ruby-identifier">interface</span>,
      <span class="ruby-identifier">local_service_request</span>,
      <span class="ruby-identifier">local_service_response</span>
    )
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">local_service_response</span>.<span class="ruby-identifier">halt_processing?</span>
    <span class="ruby-ivar">@service_response</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">merge!</span>( <span class="ruby-identifier">local_service_response</span>.<span class="ruby-identifier">errors</span> )
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">local_service_request</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">body_hash</span>

  <span class="ruby-comment"># Dispatch the call, merge any errors that might have come back and</span>
  <span class="ruby-comment"># return the body of the called service&#39;s response.</span>

  <span class="ruby-identifier">debug_log</span>( <span class="ruby-node">&quot;Dispatching local inter-service call with parsed body data: &#39;#{ local_service_request.body }&#39;&quot;</span> )

  <span class="ruby-identifier">context</span> = <span class="ruby-constant">ApiTools</span><span class="ruby-operator">::</span><span class="ruby-constant">ServiceContext</span>.<span class="ruby-identifier">new</span>(
    <span class="ruby-ivar">@service_session</span>,
    <span class="ruby-identifier">local_service_request</span>,
    <span class="ruby-identifier">local_service_response</span>,
    <span class="ruby-keyword">self</span>
  )

  <span class="ruby-identifier">dispatch_to</span>( <span class="ruby-identifier">interface</span>, <span class="ruby-identifier">implementation</span>, <span class="ruby-identifier">action</span>, <span class="ruby-identifier">context</span> )

  <span class="ruby-ivar">@service_response</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">merge!</span>( <span class="ruby-identifier">local_service_response</span>.<span class="ruby-identifier">errors</span> )

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">local_service_response</span>.<span class="ruby-identifier">body</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-inter_service_remote">
            
              <b>inter_service_remote</b>( options )
            
            <a href="../../classes/ApiTools/ServiceMiddleware.html#method-i-inter_service_remote" name="method-i-inter_service_remote" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Make a remote (HTTP) inter-service call. Slow.</p>
<dl class="rdoc-list note-list"><dt>options
<dd>
<p>See <a
href="ServiceMiddleware.html#method-i-inter_service">inter_service</a>.</p>
</dd><dt>Returns
<dd>
<p>See <a
href="ServiceMiddleware.html#method-i-inter_service">inter_service</a>.</p>
</dd></dl>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-inter_service_remote_source')" id="l_method-i-inter_service_remote_source">show</a>
                
              </p>
              <div id="method-i-inter_service_remote_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/service_middleware/service_middleware.rb, line 1334</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">inter_service_remote</span>( <span class="ruby-identifier">options</span> )
  <span class="ruby-identifier">remote_uri</span>  = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:remote</span>      ]
  <span class="ruby-identifier">http_method</span> = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:http_method</span> ]
  <span class="ruby-identifier">ident</span>       = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:ident</span>       ]
  <span class="ruby-identifier">body_hash</span>   = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:body_hash</span>   ]
  <span class="ruby-identifier">query_hash</span>  = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:query_hash</span>  ]

  <span class="ruby-comment"># Add a 404 error to the response (via a Proc for internal reuse).</span>

  <span class="ruby-identifier">add_404</span> = <span class="ruby-constant">Proc</span>.<span class="ruby-identifier">new</span> {
    <span class="ruby-ivar">@service_response</span>.<span class="ruby-identifier">add_error</span>(
      <span class="ruby-string">&#39;platform.not_found&#39;</span>,
      <span class="ruby-string">&#39;reference&#39;</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-value">:entity_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;v#{ options[ :version ] } of #{ options[ :resource ] } interface endpoint&quot;</span> }
    )
  }

  <span class="ruby-comment"># No endpoint found? Yikes!</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">remote_uri</span>.<span class="ruby-identifier">nil?</span> )
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">add_404</span>.<span class="ruby-identifier">call</span>()

  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">remote_uri</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;/#{ URI::escape( ident ) }&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ident</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Grey area over whether this encodes spaces as &quot;%20&quot; or &quot;+&quot;, but so</span>
  <span class="ruby-comment"># long as the middleware consistently uses the URI encode/decode calls,</span>
  <span class="ruby-comment"># it should work out in the end anyway.</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">query_hash</span> = <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">dup</span>
    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;search&#39;</span> ] = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">encode_www_form</span>( <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;search&#39;</span> ] ) <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;search&#39;</span> ].<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Hash</span> ) )
    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;filter&#39;</span> ] = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">encode_www_form</span>( <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;filter&#39;</span> ] ) <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;filter&#39;</span> ].<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Hash</span> ) )

    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ] = <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ].<span class="ruby-identifier">join</span>( <span class="ruby-string">&#39;,&#39;</span> ) <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ].<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Array</span> ) )
    <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ] = <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ].<span class="ruby-identifier">join</span>( <span class="ruby-string">&#39;,&#39;</span> ) <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ].<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Array</span> ) )

    <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-string">&#39;search&#39;</span>     ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;search&#39;</span>     ].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;search&#39;</span>     ].<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-string">&#39;filter&#39;</span>     ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;filter&#39;</span>     ].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;filter&#39;</span>     ].<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-string">&#39;_embed&#39;</span>     ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_embed&#39;</span>     ].<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-string">&#39;_reference&#39;</span> ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">query_hash</span>[ <span class="ruby-string">&#39;_reference&#39;</span> ].<span class="ruby-identifier">empty?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">query_hash</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">remote_uri</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&#39;?&#39;</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">URI</span>.<span class="ruby-identifier">encode_www_form</span>( <span class="ruby-identifier">query_hash</span> )
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">body_data</span> = <span class="ruby-identifier">body_hash</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-string">&#39;&#39;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">body_hash</span>.<span class="ruby-identifier">to_json</span>
  <span class="ruby-identifier">headers</span>   = {
    <span class="ruby-string">&#39;Content-Type&#39;</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;application/json; charset=utf-8&#39;</span>,
    <span class="ruby-string">&#39;Content-Language&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@locale</span>,
    <span class="ruby-string">&#39;X-Interaction-ID&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@interaction_id</span> <span class="ruby-operator">||</span> <span class="ruby-string">&#39;+&#39;</span>,
    <span class="ruby-string">&#39;X-Session-ID&#39;</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@session_id</span>     <span class="ruby-operator">||</span> <span class="ruby-string">&#39;+&#39;</span>
  }

  <span class="ruby-comment"># Drive the HTTP library using the data assembled above</span>

  <span class="ruby-identifier">remote_uri</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">remote_uri</span> )
  <span class="ruby-identifier">http</span>       = <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">remote_uri</span>.<span class="ruby-identifier">host</span>, <span class="ruby-identifier">remote_uri</span>.<span class="ruby-identifier">port</span> )

  <span class="ruby-identifier">request_class</span> = {
    <span class="ruby-string">&#39;POST&#39;</span>   =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Post</span>,
    <span class="ruby-string">&#39;PATCH&#39;</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Patch</span>,
    <span class="ruby-string">&#39;DELETE&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Delete</span>
  }[ <span class="ruby-identifier">http_method</span> ] <span class="ruby-operator">||</span> <span class="ruby-constant">Net</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span><span class="ruby-operator">::</span><span class="ruby-constant">Get</span>

  <span class="ruby-identifier">request</span>      = <span class="ruby-identifier">request_class</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">remote_uri</span>.<span class="ruby-identifier">request_uri</span>() )
  <span class="ruby-identifier">request</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">body_data</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">body_data</span>.<span class="ruby-identifier">empty?</span>

  <span class="ruby-identifier">request</span>.<span class="ruby-identifier">initialize_http_header</span>( <span class="ruby-identifier">headers</span> )

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">response</span> = <span class="ruby-identifier">http</span>.<span class="ruby-identifier">request</span>( <span class="ruby-identifier">request</span> )
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNREFUSED</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">add_404</span>.<span class="ruby-identifier">call</span>()
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Parse the response (assumed valid JSON else #for_rack would have failed</span>
  <span class="ruby-comment"># when the originating response object was turned into the Rack response).</span>

  <span class="ruby-identifier">parsed</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">response</span>.<span class="ruby-identifier">body</span> )

  <span class="ruby-comment"># Deal with headers sent in the call.</span>

  <span class="ruby-identifier">ignores</span> = <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span>( [

    <span class="ruby-comment"># These are standard and automatic anyway</span>

    <span class="ruby-string">&#39;content-type&#39;</span>,
    <span class="ruby-string">&#39;content-language&#39;</span>,
    <span class="ruby-string">&#39;x-interaction-id&#39;</span>,
    <span class="ruby-string">&#39;x-session-id&#39;</span>,

    <span class="ruby-comment"># These can be set by HTTP operations and we&#39;re not interested in them</span>

    <span class="ruby-string">&#39;content-length&#39;</span>,
    <span class="ruby-string">&#39;server&#39;</span>,
    <span class="ruby-string">&#39;date&#39;</span>,
    <span class="ruby-string">&#39;connection&#39;</span>

  ] )

  <span class="ruby-identifier">response</span>.<span class="ruby-identifier">each_header</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">name</span>, <span class="ruby-identifier">value</span> <span class="ruby-operator">|</span>
    <span class="ruby-ivar">@service_response</span>.<span class="ruby-identifier">add_header</span>( <span class="ruby-identifier">name</span>, <span class="ruby-identifier">value</span>, <span class="ruby-keyword">true</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ignores</span>.<span class="ruby-identifier">include?</span>( <span class="ruby-identifier">name</span> )
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Since &quot;parsed&quot; now has the decoded Hash payload, we use it to see if</span>
  <span class="ruby-comment"># there is error data there. If so, add it verbatim into the local errors</span>
  <span class="ruby-comment"># collection. Attempt to carry over the remote call&#39;s HTTP status code.</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">response</span>.<span class="ruby-identifier">code</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-number">299</span>
    <span class="ruby-ivar">@service_response</span>.<span class="ruby-identifier">http_status_code</span> = <span class="ruby-identifier">response</span>.<span class="ruby-identifier">code</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">parsed</span>[ <span class="ruby-string">&#39;kind&#39;</span> ] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;Errors&#39;</span> )
    <span class="ruby-identifier">parsed</span>[ <span class="ruby-string">&#39;errors&#39;</span> ].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">error</span> <span class="ruby-operator">|</span>
      <span class="ruby-ivar">@service_response</span>.<span class="ruby-identifier">add_precompiled_error</span>(
        <span class="ruby-identifier">error</span>[ <span class="ruby-string">&#39;code&#39;</span>      ],
        <span class="ruby-identifier">error</span>[ <span class="ruby-string">&#39;message&#39;</span>   ],
        <span class="ruby-identifier">error</span>[ <span class="ruby-string">&#39;reference&#39;</span> ],
        <span class="ruby-identifier">response</span>.<span class="ruby-identifier">code</span>
      )
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># If the parsed data wrapped an array, extract just the array part.</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">parsed</span>[ <span class="ruby-string">&#39;_data&#39;</span> ].<span class="ruby-identifier">is_a?</span>( <span class="ruby-operator">::</span><span class="ruby-constant">Array</span> ) )
    <span class="ruby-identifier">parsed</span> = <span class="ruby-identifier">parsed</span>[ <span class="ruby-string">&#39;_data&#39;</span> ]
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">parsed</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-local_service_for">
            
              <b>local_service_for</b>( resource, version = 1 )
            
            <a href="../../classes/ApiTools/ServiceMiddleware.html#method-i-local_service_for" name="method-i-local_service_for" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Is the given resource available as a local endpoint in this service
application?</p>
<dl class="rdoc-list note-list"><dt>resource
<dd>
<p>Resource name of interest, e.g. <code>:Purchase</code>. String or symbol.</p>
</dd><dt><code>version</code>
<dd>
<p>Version of interface required as an Integer. Optional - default is 1.</p>
</dd></dl>

<p>Returns an @services entry (see implementation of initialize) if local,
else <code>nil</code>.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-local_service_for_source')" id="l_method-i-local_service_for_source">show</a>
                
              </p>
              <div id="method-i-local_service_for_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/service_middleware/service_middleware.rb, line 1248</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">local_service_for</span>( <span class="ruby-identifier">resource</span>, <span class="ruby-identifier">version</span> = <span class="ruby-number">1</span> )
  <span class="ruby-identifier">resource</span> = <span class="ruby-identifier">resource</span>.<span class="ruby-identifier">to_sym</span>
  <span class="ruby-identifier">version</span>  = <span class="ruby-identifier">version</span>.<span class="ruby-identifier">to_i</span>

  <span class="ruby-ivar">@services</span>.<span class="ruby-identifier">find</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">entry</span> <span class="ruby-operator">|</span>
    <span class="ruby-identifier">interface</span> = <span class="ruby-identifier">entry</span>[ <span class="ruby-value">:interface</span> ]
    <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">resource</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">resource</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">version</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">version</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-remote_service_for">
            
              <b>remote_service_for</b>( resource, version = 1 )
            
            <a href="../../classes/ApiTools/ServiceMiddleware.html#method-i-remote_service_for" name="method-i-remote_service_for" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Is the given resource available as a remote endpoint we can target via
HTTP?</p>
<dl class="rdoc-list note-list"><dt>resource
<dd>
<p>Resource name of interest, e.g. <code>:Purchase</code>. String or symbol.</p>
</dd><dt><code>version</code>
<dd>
<p>Version of interface required as an Integer. Optional - default is 1.</p>
</dd></dl>

<p>Returns a URI as a string if an endpoint is found, else <code>nil</code>.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-remote_service_for_source')" id="l_method-i-remote_service_for_source">show</a>
                
              </p>
              <div id="method-i-remote_service_for_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/service_middleware/service_middleware.rb, line 1269</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">remote_service_for</span>( <span class="ruby-identifier">resource</span>, <span class="ruby-identifier">version</span> = <span class="ruby-number">1</span> )
  <span class="ruby-keyword">begin</span>
    <span class="ruby-ivar">@drb_service</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">resource</span>, <span class="ruby-identifier">version</span> )
  <span class="ruby-keyword">rescue</span>
    <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>

    </div>
  </body>
</html>    