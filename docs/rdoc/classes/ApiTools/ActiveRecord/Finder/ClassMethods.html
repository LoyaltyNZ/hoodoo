<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>ApiTools::ActiveRecord::Finder::ClassMethods</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../../css/github.css" type="text/css" media="screen" />
<script src="../../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            <span class="type">Module</span> 
            ApiTools::ActiveRecord::Finder::ClassMethods 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../../files/lib/api_tools/active_record/finder_rb.html">lib/api_tools/active_record/finder.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>Collection of class methods that get defined on an including class via <a
href="../Finder.html#method-c-included">ApiTools::ActiveRecord::Finder.included</a>.</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>L</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-list_filter_map">list_filter_map</a>,
              </li>
            
              
              <li>
                <a href="#method-i-list_finder">list_finder</a>,
              </li>
            
              
              <li>
                <a href="#method-i-list_search_map">list_search_map</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-polymorphic_find">polymorphic_find</a>,
              </li>
            
              
              <li>
                <a href="#method-i-polymorphic_id_fields">polymorphic_id_fields</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    


    <!-- Methods -->
        
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-list_filter_map">
            
              <b>list_filter_map</b>( map )
            
            <a href="../../../../classes/ApiTools/ActiveRecord/Finder/ClassMethods.html#method-i-list_filter_map" name="method-i-list_filter_map" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>As <a
href="ClassMethods.html#method-i-list_search_map">list_search_map</a>, but
used in <code>where.not</code> queries.</p>
<dl class="rdoc-list note-list"><dt>map
<dd>
<p>As <a
href="ClassMethods.html#method-i-list_search_map">list_search_map</a>.</p>
</dd></dl>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-list_filter_map_source')" id="l_method-i-list_filter_map_source">show</a>
                
              </p>
              <div id="method-i-list_filter_map_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/active_record/finder.rb, line 273</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">list_filter_map</span>( <span class="ruby-identifier">map</span> )
  <span class="ruby-identifier">class_variable_set</span>( <span class="ruby-string">&#39;@@nz_co_loyalty_list_filter_map&#39;</span>, <span class="ruby-identifier">map</span> )
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-list_finder">
            
              <b>list_finder</b>( context )
            
            <a href="../../../../classes/ApiTools/ActiveRecord/Finder/ClassMethods.html#method-i-list_finder" name="method-i-list_finder" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Generate an ActiveRecord::Relation instance which can be used to count,
retrieve or further refine a list of model instances from the database.</p>

<p>The returned relation is generated via a given instance of <a
href="../../ServiceContext.html">ApiTools::ServiceContext</a>. It takes
into account the context&#39;s <a
href="../../ServiceRequest.html">ApiTools::ServiceRequest</a> and the list
offset, list limit, list sort key and list sort direction automatically. In
addition, it can do simple search and filter operations if search and
filter mappings are set up via <a
href="ClassMethods.html#method-i-list_search_map">list_search_map</a> and
<a href="ClassMethods.html#method-i-list_filter_map">list_filter_map</a>.</p>

<p>For exampe, in a simple case where a model can be listed without any
unusual constraints, we might do this:</p>

<pre><code>class SomeModel &lt; ActiveRecord::Base
  include ApiTools::ActiveRecord::Finder
end

# ...elsewhere...

def list( context )
  finder = SomeModel.list_finder( context )
  results = finder.all.map do | item |
    # ...map database objects to response objects...
  end
  context.response.body = results
end
</code></pre>

<p>(Bear in mind that the service middleware enforces sane values for things
like list offsets, sort keys and so-on according to service interface
definitions, so if using the middleware you don&#39;t need to do any extra
checking).</p>

<p>Since the returned object is just a relation, adding further constraints is
easy - call things like <code>where</code>, <code>group</code> and so-on as
normal. For example, suppose caller authoristion layers provide a session
with a <code>client_id</code> and you implicitly only allow lookups for
instances owned by that client, through storing the value with the model in
a field of the same name. The previous example changes only a little:</p>

<pre><code>def list( context )
  finder = SomeModel.list_finder( context )
  finder = finder.where( :client_id =&gt; context.session.client_id )
  results = finder.all.map do | item |
    # ...map database objects to response objects...
  end
  context.response.body = results
end
</code></pre>

<p>Any of the ActiveRecord::QueryMethods can be called on the returned value.
See:</p>

<p><a
href="http://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html">api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html</a></p>
<dl class="rdoc-list note-list"><dt><code>context</code>
<dd>
<p><a href="../../ServiceContext.html">ApiTools::ServiceContext</a> instance.</p>
</dd></dl>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-list_finder_source')" id="l_method-i-list_finder_source">show</a>
                
              </p>
              <div id="method-i-list_finder_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/active_record/finder.rb, line 173</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">list_finder</span>( <span class="ruby-identifier">context</span> )
  <span class="ruby-identifier">finder</span> = <span class="ruby-keyword">self</span>
  <span class="ruby-identifier">finder</span> = <span class="ruby-identifier">finder</span>.<span class="ruby-identifier">offset</span>( <span class="ruby-identifier">context</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">list_offset</span> ).<span class="ruby-identifier">limit</span>( <span class="ruby-identifier">context</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">list_limit</span> )
  <span class="ruby-identifier">finder</span> = <span class="ruby-identifier">finder</span>.<span class="ruby-identifier">order</span>( { <span class="ruby-identifier">context</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">list_sort_key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">context</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">list_sort_direction</span>.<span class="ruby-identifier">to_sym</span> } )

  <span class="ruby-identifier">search_map</span> = <span class="ruby-identifier">class_variable_get</span>( <span class="ruby-string">&#39;@@nz_co_loyalty_list_search_map&#39;</span> )

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_map</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">search_map</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">attr</span>, <span class="ruby-identifier">proc</span> <span class="ruby-operator">|</span>
      <span class="ruby-identifier">value</span> = <span class="ruby-identifier">context</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">list_search_data</span>[ <span class="ruby-identifier">attr</span> ]
      <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span>

      <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">proc</span>.<span class="ruby-identifier">nil?</span> )
        <span class="ruby-identifier">args_for_where</span> = [ { <span class="ruby-identifier">attr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">value</span> } ]
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">args_for_where</span> = <span class="ruby-identifier">proc</span>.<span class="ruby-identifier">call</span>( <span class="ruby-identifier">attr</span>, <span class="ruby-identifier">value</span> )
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">finder</span> = <span class="ruby-identifier">finder</span>.<span class="ruby-identifier">where</span>( <span class="ruby-operator">*</span><span class="ruby-identifier">args_for_where</span> )
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">filter_map</span> = <span class="ruby-identifier">class_variable_get</span>( <span class="ruby-string">&#39;@@nz_co_loyalty_list_filter_map&#39;</span> )

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">filter_map</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">filter_map</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">attr</span>, <span class="ruby-identifier">proc</span> <span class="ruby-operator">|</span>
      <span class="ruby-identifier">value</span> = <span class="ruby-identifier">context</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">list_filter_data</span>[ <span class="ruby-identifier">attr</span> ]
      <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span>

      <span class="ruby-keyword">if</span> ( <span class="ruby-identifier">proc</span>.<span class="ruby-identifier">nil?</span> )
        <span class="ruby-identifier">args_for_where_not</span> = [ { <span class="ruby-identifier">attr</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">value</span> } ]
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">args_for_where_not</span> = <span class="ruby-identifier">proc</span>.<span class="ruby-identifier">call</span>( <span class="ruby-identifier">attr</span>, <span class="ruby-identifier">value</span> )
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">finder</span> = <span class="ruby-identifier">finder</span>.<span class="ruby-identifier">where</span>.<span class="ruby-identifier">not</span>( <span class="ruby-operator">*</span><span class="ruby-identifier">args_for_where_not</span> )
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-list_search_map">
            
              <b>list_search_map</b>( map )
            
            <a href="../../../../classes/ApiTools/ActiveRecord/Finder/ClassMethods.html#method-i-list_search_map" name="method-i-list_search_map" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Specify a search mapping for use by <a
href="ClassMethods.html#method-i-list_finder">list_finder</a> to
automatically restrict list results.</p>

<p>Simple example which just looks for verbatim field matches on fields
<code>name</code> and <code>colour</code>:</p>

<pre><code>class SomeModel &lt; ActiveRecord::Base
  list_search_map {
    :name =&gt; nil,
    :colour =&gt; nil
  }
end
</code></pre>

<p>More complex example where <code>colour</code> is matched verbatim, but
<code>name</code> is matched case-insensitive:</p>

<pre><code>class SomeModel &lt; ActiveRecord::Base
  list_search_map {
    :name =&gt; Proc.new { | attr, value |
      [ &quot;name ILIKE ?&quot;, value ]
    },
    :colour =&gt; nil
  }
end
</code></pre>

<p>Extending the above to use a single Proc that handles case insensitive
matches across all attributes:</p>

<pre><code>class SomeModel &lt; ActiveRecord::Base
  CI_MATCH = Proc.new { | attr, value |
    [ &quot;#{ attr } ILIKE ?&quot;, value ]
  }

  list_search_map {
    :name   =&gt; CI_MATCH,
    :colour =&gt; CI_MATCH
  }
end
</code></pre>
<dl class="rdoc-list note-list"><dt><code>map</code>
<dd>
<p>A Hash. Keys are attribute names. Values of <code>nil</code> are used for
simple cases - +where( { attr_name =&gt; value } )+ will be the resulting
query modification. Alternatively, pass a callable Proc/Lambda. This is
pased the attribute under consideration and the context-caller-supplied
value to search on for that attribute. Return <strong>AN</strong>
<strong>ARRAY</strong> of parameters to pass to <code>where</code>. For
parameters to <code>where</code>, see:</p>

<p><a
href="http://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where">api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where</a></p>

<p>The Hash keys giving the search attribute names can be specified as Strings
or Symbols.</p>
</dd></dl>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-list_search_map_source')" id="l_method-i-list_search_map_source">show</a>
                
              </p>
              <div id="method-i-list_search_map_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/active_record/finder.rb, line 265</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">list_search_map</span>( <span class="ruby-identifier">map</span> )
  <span class="ruby-identifier">class_variable_set</span>( <span class="ruby-string">&#39;@@nz_co_loyalty_list_search_map&#39;</span>, <span class="ruby-identifier">map</span> )
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-polymorphic_find">
            
              <b>polymorphic_find</b>( finder, ident )
            
            <a href="../../../../classes/ApiTools/ActiveRecord/Finder/ClassMethods.html#method-i-polymorphic_find" name="method-i-polymorphic_find" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>“Polymorphic” find - support for finding a model by fields other than just
<code>:id</code>, based on a single unique identifier. The attributes to be
searched upon are specified via <a
href="ClassMethods.html#method-i-polymorphic_id_fields">polymorphic_id_fields</a>;
<code>:id</code> is always included as a lookup attribute and will be
checked first.</p>

<p>Pass an ActiveRecord::Relation instance or the model class itself as the
base finder, then the identifier. To explain this more - in the simple
case, you might just want to search across several fields for a match
against the identifier thus:</p>

<pre><code>class SomeModel &lt; ActiveRecord::Base
  include ApiTools::ActiveRecord::Finder
end

# ...elsewhere...

def show( context )
  found = SomeModel.polymorphic_find( SomeModel, context.request.ident )
  # ...
end
</code></pre>

<p>More often, though, you might want to restrict the search to model
instances matching certain fields, perhaps for security reasons. Maybe
caller authoristion layers provide a session with a <code>client_id</code>
and you implicitly only allow lookups for instances owned by that client,
through storing the value with the model in a field of the same name.</p>

<pre><code>def show( context )
  finder = SomeModel.where( :client_id =&gt; context.session.client_id )
  found = SomeModel.polymorphic_find( finder, context.request.ident )
  # ...
end
</code></pre>
<dl class="rdoc-list note-list"><dt><code>finder</code>
<dd>
<p>An <a href="../Base.html">ActiveRecord::Base</a> subclass or
ActiveRecord::Relation instance - something that the likes of
<code>where</code> can be sent to, as part of building up a query chain;
the ActiveRecord::QueryMethods must be supported.</p>

<p><a
href="http://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html">api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html</a></p>
</dd><dt><code>ident</code>
<dd>
<p>The value to search for in the fields (attributes) specified via <a
href="ClassMethods.html#method-i-polymorphic_id_fields">polymorphic_id_fields</a>,
using +where( attr =&gt; ident )+.</p>
</dd></dl>

<p>Returns a found model instance or <code>nil</code> for no match.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-polymorphic_find_source')" id="l_method-i-polymorphic_find_source">show</a>
                
              </p>
              <div id="method-i-polymorphic_find_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/active_record/finder.rb, line 83</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">polymorphic_find</span>( <span class="ruby-identifier">finder</span>, <span class="ruby-identifier">ident</span> )
  <span class="ruby-identifier">extra_fields</span> = <span class="ruby-identifier">class_variable_get</span>( <span class="ruby-string">&#39;@@nz_co_loyalty_show_id_fields&#39;</span> ) <span class="ruby-operator">||</span> []
  <span class="ruby-identifier">id_fields</span>    = [ <span class="ruby-value">:id</span> ] <span class="ruby-operator">+</span> <span class="ruby-identifier">extra_fields</span>

  <span class="ruby-identifier">id_fields</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">field</span> <span class="ruby-operator">|</span>
    <span class="ruby-identifier">checker</span> = <span class="ruby-identifier">finder</span>.<span class="ruby-identifier">where</span>( <span class="ruby-identifier">field</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ident</span> )
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">checker</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">checker</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">==</span> <span class="ruby-number">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-polymorphic_id_fields">
            
              <b>polymorphic_id_fields</b>( *args )
            
            <a href="../../../../classes/ApiTools/ActiveRecord/Finder/ClassMethods.html#method-i-polymorphic_id_fields" name="method-i-polymorphic_id_fields" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Specify the fields (attributes / columns) upon which <a
href="ClassMethods.html#method-i-polymorphic_find">polymorphic_find</a>
will perform its search. <code>:id</code> is included by default always and
does not need specifying.</p>

<p>For example, if a model supported looking up via a <a
href="../UUID.html">UUID</a> in the <code>:id</code> attribute or through a
secondary unique identifier in the <code>:code</code> attribute, then
declare the situation thus:</p>

<pre><code>class SomeModel &lt; ActiveRecord::Base
  include ApiTools::ActiveRecord::Finder
  polymorphic_id_fields :code
end
</code></pre>

<p>…and find records via <a
href="ClassMethods.html#method-i-polymorphic_find">polymorphic_find</a>.</p>
<dl class="rdoc-list note-list"><dt>*args
<dd>
<p>One or more fields (attributes), as Symbols.</p>
</dd></dl>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-polymorphic_id_fields_source')" id="l_method-i-polymorphic_id_fields_source">show</a>
                
              </p>
              <div id="method-i-polymorphic_id_fields_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/api_tools/active_record/finder.rb, line 112</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">polymorphic_id_fields</span>( <span class="ruby-operator">*</span><span class="ruby-identifier">args</span> )
  <span class="ruby-identifier">class_variable_set</span>( <span class="ruby-string">&#39;@@nz_co_loyalty_show_id_fields&#39;</span>, <span class="ruby-identifier">args</span> )
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>

    </div>
  </body>
</html>    