<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class Hoodoo::Services::Session - Hoodoo</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/navigation.js" defer></script>
<script src="../../js/search.js" defer></script>
<script src="../../js/search_index.js" defer></script>
<script src="../../js/searcher.js" defer></script>
<script src="../../js/darkfish.js" defer></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">


<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
<div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  <p class="link">Object
</div>

    
    
    
<!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    <li ><a href="#method-c-new">::new</a>
    <li ><a href="#method-i-augment_with_permissions_for">#augment_with_permissions_for</a>
    <li ><a href="#method-i-delete_from_memcached">#delete_from_memcached</a>
    <li ><a href="#method-i-delete_from_store">#delete_from_store</a>
    <li ><a href="#method-i-expired-3F">#expired?</a>
    <li ><a href="#method-i-from_h-21">#from_h!</a>
    <li ><a href="#method-i-identity-3D">#identity=</a>
    <li ><a href="#method-i-load_from_memcached-21">#load_from_memcached!</a>
    <li ><a href="#method-i-load_from_store-21">#load_from_store!</a>
    <li ><a href="#method-i-memcached_host">#memcached_host</a>
    <li ><a href="#method-i-memcached_host-3D">#memcached_host=</a>
    <li ><a href="#method-i-save_to_memcached">#save_to_memcached</a>
    <li ><a href="#method-i-save_to_store">#save_to_store</a>
    <li ><a href="#method-i-scoping-3D">#scoping=</a>
    <li ><a href="#method-i-to_h">#to_h</a>
    <li ><a href="#method-i-update_caller_version_in_memcached">#update_caller_version_in_memcached</a>
    <li ><a href="#method-i-update_caller_version_in_store">#update_caller_version_in_store</a>
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Hoodoo::Services::Session">
  <h1 id="class-Hoodoo::Services::Session" class="class">
    class Hoodoo::Services::Session
  </h1>

  <section class="description">
    
<p>A container for functionality related to a context session.</p>

  </section>

  <section id="5Buntitled-5D" class="documentation-section">


    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
        <dt id="MockDalliClient">MockDalliClient
        <dd><p>Before <a href="../TransientStore.html"><code>Hoodoo::TransientStore</code></a> was created, the <a href="Session.html"><code>Session</code></a> system was directly tied into Memcached and had a mock backend used for tests without a Redis dependency. This now lives in <a href="../TransientStore/Mocks/DalliClient.html"><code>Hoodoo::TransientStore::Mocks::DalliClient</code></a>, but for any code out in the wild which might use the old <a href="Session.html"><code>Session</code></a> namespace version, we add what amounts to a class alias here.</p>
        <dt id="TTL">TTL
        <dd><p>Time To Live: Number of seconds for which a session remains valid after being saved.</p>
      </dl>
    </section>

    <section class="attribute-method-details" class="method-section">
      <header>
        <h3>Attributes</h3>
      </header>

      <div id="attribute-i-caller_fingerprint" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">caller_fingerprint</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        <p>An optional property of a session is the Caller’s fingerprint, a <a href="../UUID.html"><code>UUID</code></a> assigned to some Callers which can be persisted by resource instances when created and rendered in the <code>created_by</code> field via e.g. <a href="../Presenters/Base.html"><code>Hoodoo::Presenters::Base</code></a>.#render_in.</p>
        </div>
      </div>
      <div id="attribute-i-caller_id" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">caller_id</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        <p>A <a href="Session.html"><code>Session</code></a> must always refer to a Caller instance by <a href="../UUID.html"><code>UUID</code></a>.</p>
        </div>
      </div>
      <div id="attribute-i-caller_identity_name" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">caller_identity_name</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        <p>An optional property of a session is the Caller’s “identity name”, a generic way to refer to this Caller which will appear in logs. The use is up to the session creator, in combination with whatever logging engine is in use; if it ascribes meaning to the identity name, then the session creator must ensure it comforms.</p>
        </div>
      </div>
      <div id="attribute-i-caller_version" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">caller_version</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        <p>Callers can change; if so, related sessions must be invalidated. This must be achieved by keeping a version count on the Caller. A session is associated with a particular Caller version and if the version changes, associated sessions are flushed.</p>

<p>If you <em>change</em> a Caller version in a <a href="Session.html"><code>Session</code></a>, you <em>really</em> should call <a href="Session.html#method-i-save_to_store"><code>save_to_store</code></a> as soon as possible afterwards so that the change gets recognised in the <a href="../TransientStore.html"><code>Hoodoo::TransientStore</code></a>.</p>
        </div>
      </div>
      <div id="attribute-i-created_at" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">created_at</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        <p>The creation date of this session instance as a Time instance in UTC.</p>
        </div>
      </div>
      <div id="attribute-i-expires_at" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">expires_at</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        <p>The expiry date for this session - the session should be considered expired at or after this date. Some session stores may support automatic expiry of session data, but there may be a small window between the expiry date passing and the store expiring the data; so always check the expiry.</p>

<p>Only set when the session is saved (or loaded from a representation that includes an existing expiry date). See e.g.:</p>
<ul><li>
<p><a href="Session.html#method-i-save_to_store"><code>save_to_store</code></a></p>
</li></ul>

<p>The value is a Time instance in UTC. If <code>nil</code>, the session has not yet been saved.</p>
        </div>
      </div>
      <div id="attribute-i-identity" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">identity</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        <p>An OpenStruct instance with session-creator defined key/value pairs that define the <em>identity</em> of the session holder. This is usually related to a Caller resource instance - see also <a href="../Data/Resources/Caller.html"><code>Hoodoo::Data::Resources::Caller</code></a> - and will often contain a Caller resource instance’s <a href="../UUID.html"><code>UUID</code></a>, amongst other data.</p>

<p>The object describes “who the session’s owner is”.</p>
        </div>
      </div>
      <div id="attribute-i-permissions" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">permissions</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        <p>A <a href="Permissions.html"><code>Hoodoo::Services::Permissions</code></a> instance.</p>

<p>The instance describes “what the session is allowed to do”.</p>
        </div>
      </div>
      <div id="attribute-i-scoping" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">scoping</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        <p>An OpenStruct instance with session-creator defined values that describe the <em>scoping</em>, that is, visbility of data, for the session. Its contents relate to service resource interface descriptions (see the DSL for <a href="Interface.html"><code>Hoodoo::Services::Interface</code></a>) and may be partially or entirely supported by the <a href="../ActiveRecord.html"><code>ActiveRecord</code></a> finder extensions in <a href="../ActiveRecord/Finder.html"><code>Hoodoo::ActiveRecord::Finder</code></a>.</p>

<p>The object describes the “data that the session can ‘see’”.</p>
        </div>
      </div>
      <div id="attribute-i-session_id" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">session_id</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        <p>A <a href="Session.html"><code>Session</code></a> must have its own <a href="../UUID.html"><code>UUID</code></a>.</p>
        </div>
      </div>
      <div id="attribute-i-storage_engine" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">storage_engine</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        <p>Declares the transient storage engine this session will write to. Both this and <code>storage_host_uri</code> are used within <a href="../TransientStore.html#method-c-new"><code>Hoodoo::TransientStore::new</code></a>.</p>
        </div>
      </div>
      <div id="attribute-i-storage_host_uri" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">storage_host_uri</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        <p>Connection IP address/port String for the selected storage engine. The connection host can be set either through this accessor, or via the object’s constructor.</p>
        </div>
      </div>
    </section>


     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

      <div id="method-c-new" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">( options = {} )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Create a new instance.</p>
<dl class="rdoc-list note-list"><dt><code>options</code>
<dd>
<p>Optional Hash of options, described below.</p>
</dd></dl>

<p>Options are:</p>
<dl class="rdoc-list note-list"><dt><code>session_id</code>
<dd>
<p><a href="../UUID.html"><code>UUID</code></a> of this session. If unset, a new <a href="../UUID.html"><code>UUID</code></a> is generated for you. You can read the <a href="../UUID.html"><code>UUID</code></a> with the <a href="Session.html#attribute-i-session_id"><code>session_id</code></a> accessor method.</p>
</dd><dt><code>caller_id</code>
<dd>
<p><a href="../UUID.html"><code>UUID</code></a> of the Caller instance associated with this session. This can be set either now or later, but the session cannot be saved without it.</p>
</dd><dt><code>caller_version</code>
<dd>
<p>Version of the Caller instance. Defaults to zero.</p>
</dd><dt><code>caller_fingerprint</code>
<dd>
<p>Optional Caller fingerprint <a href="../UUID.html"><code>UUID</code></a>. Defaults to <code>nil</code>.</p>
</dd><dt><code>storage_engine</code>
<dd>
<p>An entry (Symbol) from <a href="../TransientStore.html#method-c-supported_storage_engines"><code>Hoodoo::TransientStore::supported_storage_engines</code></a>. Defaults to <code>:memcached</code>.</p>
</dd><dt><code>storage_host_uri</code>
<dd>
<p>URI for <a href="../TransientStore.html"><code>Hoodoo::TransientStore</code></a> engine connections.</p>
</dd><dt><code>memcached_host</code>
<dd>
<p>Host for Memcached connections (deprecated).</p>
</dd></dl>

          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 163</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">initialize</span>( <span class="ruby-identifier">options</span> = {} )
  <span class="ruby-ivar">@created_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">session_id</span>         = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:session_id</span>         ] <span class="ruby-operator">||</span> <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">UUID</span>.<span class="ruby-identifier">generate</span>()
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">storage_engine</span>     = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:storage_engine</span>     ] <span class="ruby-operator">||</span> <span class="ruby-value">:memcached</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">storage_host_uri</span>   = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:storage_host_uri</span>   ] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[ <span class="ruby-value">:memcached_host</span> ]
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">caller_id</span>          = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:caller_id</span>          ]
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">caller_version</span>     = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:caller_version</span>     ] <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">caller_fingerprint</span> = <span class="ruby-identifier">options</span>[ <span class="ruby-value">:caller_fingerprint</span> ]
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

    </section>

     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

      <div id="method-i-augment_with_permissions_for" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">augment_with_permissions_for</span><span
            class="method-args">( interaction )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Speciality interface usually only called by the middleware, or components closely related to the middleware.</p>

<p>Takes this session and creates a copy for an inter-resource call which adds any additional parameters that the calling interface says it needs in order to complete the currently handled action.</p>

<p>Through calling this method, the middleware implements the access permission functionality described by <a href="Interface.html#method-i-additional_permissions_for"><code>Hoodoo::Services::Interface#additional_permissions_for</code></a>.</p>
<dl class="rdoc-list note-list"><dt><code>interaction</code>
<dd>
<p><a href="Middleware/Interaction.html"><code>Hoodoo::Services::Middleware::Interaction</code></a> instance describing the current interaction. This is for the request that a resource implementation *is handling* at the point it wants to make an inter-resource call</p>
<ul><li>
<p>it is <strong>not</strong> data related to the <strong>target</strong> of that</p>
</li></ul>

<p>call.</p>
</dd></dl>

<p>Returns:</p>
<ul><li>
<p><a href="Session.html"><code>Hoodoo::Services::Session</code></a> instance if everything works OK; this may be the same as, or different from, the input session depending on whether or not there were any permissions that needed adding.</p>
</li><li>
<p><code>false</code> if the session can’t be saved due to a mismatched caller version - the session must have become invalid <em>during</em> handling.</p>
</li></ul>

<p>If the augmented session cannot be saved due to a storage problem, an exception is raised and the generic handler will turn this into a 500 response for the caller. At this time, we really can’t do much better than that since failure to save the augmented session means the inter-resource call cannot proceed; it’s an internal fault.</p>

          <div class="method-source-code" id="augment_with_permissions_for-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 652</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">augment_with_permissions_for</span>( <span class="ruby-identifier">interaction</span> )

  <span class="ruby-comment"># Set up some convenience variables</span>

  <span class="ruby-identifier">interface</span> = <span class="ruby-identifier">interaction</span>.<span class="ruby-identifier">target_interface</span>
  <span class="ruby-identifier">action</span>    = <span class="ruby-identifier">interaction</span>.<span class="ruby-identifier">requested_action</span>

  <span class="ruby-comment"># If there are no additional permissions for this action, just return</span>
  <span class="ruby-comment"># the current session back again.</span>

  <span class="ruby-identifier">action</span>                 = <span class="ruby-identifier">action</span>.<span class="ruby-identifier">to_s</span>()
  <span class="ruby-identifier">additional_permissions</span> = ( <span class="ruby-identifier">interface</span>.<span class="ruby-identifier">additional_permissions</span>() <span class="ruby-operator">||</span> {} )[ <span class="ruby-identifier">action</span> ]

  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">additional_permissions</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-comment"># Otherwise, duplicate the session and its permissions (or generate</span>
  <span class="ruby-comment"># defaults) and merge the additional permissions.</span>

  <span class="ruby-identifier">local_session</span>     = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">dup</span>()
  <span class="ruby-identifier">local_permissions</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">permissions</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">permissions</span>.<span class="ruby-identifier">dup</span>() <span class="ruby-operator">:</span> <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Permissions</span>.<span class="ruby-identifier">new</span>

  <span class="ruby-identifier">local_permissions</span>.<span class="ruby-identifier">merge!</span>( <span class="ruby-identifier">additional_permissions</span>.<span class="ruby-identifier">to_h</span>() )

  <span class="ruby-comment"># Make sure the new session has its own ID and set the updated</span>
  <span class="ruby-comment"># permissions. Then try to save it and return the result.</span>

  <span class="ruby-identifier">local_session</span>.<span class="ruby-identifier">session_id</span>  = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">UUID</span>.<span class="ruby-identifier">generate</span>()
  <span class="ruby-identifier">local_session</span>.<span class="ruby-identifier">permissions</span> = <span class="ruby-identifier">local_permissions</span>

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">local_session</span>.<span class="ruby-identifier">save_to_store</span>()
    <span class="ruby-keyword">when</span> <span class="ruby-value">:ok</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">local_session</span>

    <span class="ruby-keyword">when</span> <span class="ruby-value">:outdated</span>
      <span class="ruby-comment"># Caller version mismatch; original session is now outdated and invalid</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>

    <span class="ruby-keyword">else</span> <span class="ruby-comment"># Couldn&#39;t save it</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Unable to create interim session for inter-resource call from #{ interface.resource } / #{ action }&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-delete_from_memcached" class="method-detail method-alias">
        <div class="method-heading">
          <span class="method-name">delete_from_memcached</span><span
            class="method-args">()</span>
        </div>

        <div class="method-description">
          <p>Deprecated alias for <a href="Session.html#method-i-delete_from_store"><code>delete_from_store</code></a>, dating back to when the <a href="Session.html"><code>Session</code></a> engine was hard-coded to Memcached.</p>

        </div>


        <div class="aliases">
          Alias for: <a href="Session.html#method-i-delete_from_store">delete_from_store</a>
        </div>
      </div>

      <div id="method-i-delete_from_store" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">delete_from_store</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Delete this session from the transient store. The <a href="Session.html"><code>Session</code></a> object is not modified.</p>

<p>Returns a symbol:</p>
<ul><li>
<p><code>:ok</code>: The <a href="Session.html"><code>Session</code></a> was deleted from the transient store successfully.</p>
</li><li>
<p><code>:fail</code>: The session data could not be deleted (unexpected storage engine failure).</p>
</li></ul>

          <div class="method-source-code" id="delete_from_store-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 478</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">delete_from_store</span>
  <span class="ruby-keyword">begin</span>

    <span class="ruby-identifier">store</span>  = <span class="ruby-identifier">get_store</span>()
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">store</span>.<span class="ruby-identifier">delete</span>( <span class="ruby-value">key:</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">session_id</span> )

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">result</span>
      <span class="ruby-keyword">when</span> <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:ok</span>
      <span class="ruby-keyword">when</span> <span class="ruby-keyword">false</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-string">&#39;Unknown storage engine failure&#39;</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-identifier">result</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">rescue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">exception</span>

    <span class="ruby-comment"># Log error and return nil if the session can&#39;t be parsed</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span>(
      <span class="ruby-string">&#39;Hoodoo::Services::Session\#delete_from_store: Session delete - connection fault&#39;</span>,
      <span class="ruby-identifier">exception</span>.<span class="ruby-identifier">to_s</span>
    )

    <span class="ruby-keyword">return</span> <span class="ruby-value">:fail</span>
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div>
        </div>

        <div class="aliases">
          Also aliased as: <a href="Session.html#method-i-delete_from_memcached">delete_from_memcached</a>
        </div>

      </div>

      <div id="method-i-expired-3F" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">expired?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Has this session expired? Only valid if an expiry date is set; see <a href="Session.html#attribute-i-expires_at"><code>expires_at</code></a>.</p>

<p>Returns <code>true</code> if the session has expired, or <code>false</code> if it has either not expired, or has no expiry date set yet.</p>

          <div class="method-source-code" id="expired-3F-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 518</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">expired?</span>
  <span class="ruby-identifier">exp</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expires_at</span>()
  <span class="ruby-identifier">now</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>

  <span class="ruby-keyword">return</span> <span class="ruby-operator">!</span> ( <span class="ruby-identifier">exp</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">now</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">exp</span> )
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-from_h-21" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">from_h!</span><span
            class="method-args">( hash )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Load session parameters from a given Hash, of the form set by <a href="Session.html#method-i-to_h"><code>to_h</code></a>.</p>

<p>If appropriate Hash keys are present, will set any or all of <a href="Session.html#attribute-i-session_id"><code>session_id</code></a>, <a href="Session.html#attribute-i-identity"><code>identity</code></a>, <a href="Session.html#attribute-i-scoping"><code>scoping</code></a> and <a href="Session.html#attribute-i-permissions"><code>permissions</code></a>.</p>

          <div class="method-source-code" id="from_h-21-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 574</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">from_h!</span>( <span class="ruby-identifier">hash</span> )
  <span class="ruby-identifier">hash</span> = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Utilities</span>.<span class="ruby-identifier">stringify</span>( <span class="ruby-identifier">hash</span> )

  <span class="ruby-node">%w(

    session_id
    caller_id
    caller_version
    caller_identity_name
    caller_fingerprint

  )</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">property</span> <span class="ruby-operator">|</span>
    <span class="ruby-identifier">value</span> = <span class="ruby-identifier">hash</span>[ <span class="ruby-identifier">property</span> ]
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;#{ property }=&quot;</span>, <span class="ruby-identifier">value</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-node">%w(

    created_at
    expires_at

  )</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">property</span> <span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">hash</span>.<span class="ruby-identifier">has_key?</span>( <span class="ruby-identifier">property</span> )
      <span class="ruby-keyword">begin</span>
        <span class="ruby-identifier">instance_variable_set</span>( <span class="ruby-node">&quot;@#{ property }&quot;</span>, <span class="ruby-constant">Time</span>.<span class="ruby-identifier">parse</span>( <span class="ruby-identifier">hash</span>[ <span class="ruby-identifier">property</span> ] ).<span class="ruby-identifier">utc</span>() )
      <span class="ruby-keyword">rescue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">e</span>
        <span class="ruby-comment"># Invalid time given; keep existing date</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-node">%w(

    identity
    scoping

  )</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">property</span> <span class="ruby-operator">|</span>
    <span class="ruby-identifier">value</span> = <span class="ruby-identifier">hash</span>[ <span class="ruby-identifier">property</span> ]
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;#{ property }=&quot;</span>, <span class="ruby-constant">OpenStruct</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">value</span> ) ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">value</span> = <span class="ruby-identifier">hash</span>[ <span class="ruby-string">&#39;permissions&#39;</span> ]
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">permissions</span> = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Permissions</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">value</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-identity-3D" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">identity=</span><span
            class="method-args">( hash )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Set the identity data via a Hash of key/value pairs - see also <a href="Session.html#attribute-i-identity"><code>identity</code></a>.</p>

          <div class="method-source-code" id="identity-3D-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 73</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">identity=</span>( <span class="ruby-identifier">hash</span> )
  <span class="ruby-ivar">@identity</span> = <span class="ruby-constant">OpenStruct</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">hash</span> )
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-load_from_memcached-21" class="method-detail method-alias">
        <div class="method-heading">
          <span class="method-name">load_from_memcached!</span><span
            class="method-args">( sid )</span>
        </div>

        <div class="method-description">
          <p>Deprecated alias for <a href="Session.html#method-i-load_from_store-21"><code>load_from_store!</code></a>, dating back to when the <a href="Session.html"><code>Session</code></a> engine was hard-coded to Memcached.</p>

        </div>


        <div class="aliases">
          Alias for: <a href="Session.html#method-i-load_from_store-21">load_from_store!</a>
        </div>
      </div>

      <div id="method-i-load_from_store-21" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">load_from_store!</span><span
            class="method-args">( sid )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Load session data into this instance, overwriting instance values if the session is found. Raises an exception if there is a problem connecting to the transient store.</p>
<dl class="rdoc-list note-list"><dt><code>sid</code>
<dd>
<p>The <a href="Session.html"><code>Session</code></a> <a href="../UUID.html"><code>UUID</code></a> to look up.</p>
</dd></dl>

<p>Returns a symbol:</p>
<ul><li>
<p><code>:ok</code>: The session data was loaded OK and is valid.</p>
</li><li>
<p><code>:outdated</code>: The session data was loaded, but is outdated; either the session has expired, or its Caller version mismatches the associated stored Caller version in the transient store.</p>
</li><li>
<p><code>:not_found</code>: The session was not found.</p>
</li><li>
<p><code>:fail</code>: The session data could not be loaded (unexpected storage engine failure).</p>
</li></ul>

          <div class="method-source-code" id="load_from_store-21-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 295</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">load_from_store!</span>( <span class="ruby-identifier">sid</span> )
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">store</span>        = <span class="ruby-identifier">get_store</span>()
    <span class="ruby-identifier">session_hash</span> = <span class="ruby-identifier">store</span>.<span class="ruby-identifier">get</span>( <span class="ruby-value">key:</span> <span class="ruby-identifier">sid</span>, <span class="ruby-value">allow_throw:</span> <span class="ruby-keyword">true</span> )

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">session_hash</span>.<span class="ruby-identifier">nil?</span>
      <span class="ruby-keyword">return</span> <span class="ruby-value">:not_found</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">from_h!</span>( <span class="ruby-identifier">session_hash</span> )
      <span class="ruby-keyword">return</span> <span class="ruby-value">:outdated</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expired?</span>

      <span class="ruby-identifier">cv</span> = <span class="ruby-identifier">load_caller_version_from_store</span>( <span class="ruby-identifier">store</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">caller_id</span> )

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">cv</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">cv</span> <span class="ruby-operator">&gt;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">caller_version</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:outdated</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:ok</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">rescue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">exception</span>

    <span class="ruby-comment"># Log error and return nil if the session can&#39;t be parsed</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span>(
      <span class="ruby-string">&#39;Hoodoo::Services::Session\#load_from_store!: Session loading failed - connection fault or session corrupt&#39;</span>,
      <span class="ruby-identifier">exception</span>.<span class="ruby-identifier">to_s</span>
    )

  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-value">:fail</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>

        <div class="aliases">
          Also aliased as: <a href="Session.html#method-i-load_from_memcached-21">load_from_memcached!</a>
        </div>

      </div>

      <div id="method-i-memcached_host" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">memcached_host</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Deprecated interface (use <a href="Session.html#attribute-i-storage_host_uri"><code>storage_host_uri</code></a> instead), dating back to when the <a href="Session.html"><code>Session</code></a> engine was hard-coded to Memcached.</p>

<p>Supports backwards compatibility of options key <code>memcached_host</code>, aliases <code>storage_host_uri</code>.</p>

<p>Provides same functionality as <code>alias_method</code>, however includes a deprecation warning.</p>

<p>Similar to:</p>

<pre class="ruby"><span class="ruby-identifier">alias_method</span>( <span class="ruby-value">:memcached_host</span>, <span class="ruby-value">:storage_host_uri</span> )
</pre>

          <div class="method-source-code" id="memcached_host-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 403</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">memcached_host</span>
  <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span>(
    <span class="ruby-string">&#39;Hoodoo::Services::Session#memcached_host is deprecated - use #storage_host_uri&#39;</span>
  )

  <span class="ruby-identifier">storage_host_uri</span>()
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-memcached_host-3D" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">memcached_host=</span><span
            class="method-args">( uri )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Deprecated interface (use <a href="Session.html#attribute-i-storage_host_uri"><code>storage_host_uri=</code></a> instead), dating back to when the <a href="Session.html"><code>Session</code></a> engine was hard-coded to Memcached.</p>

<p>Provides same functionality as <code>alias_method</code>, however includes a deprecation warning.</p>

<p>Similar to:</p>

<pre class="ruby"><span class="ruby-identifier">alias_method</span>( <span class="ruby-value">:memcached_host=</span>, <span class="ruby-value">:storage_host_uri=</span> )
</pre>

          <div class="method-source-code" id="memcached_host-3D-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 421</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">memcached_host=</span>( <span class="ruby-identifier">uri</span> )
  <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span>(
    <span class="ruby-string">&#39;Hoodoo::Services::Session#memcached_host= is deprecated - use #storage_host_uri=&#39;</span>
  )

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">storage_host_uri</span> = <span class="ruby-identifier">uri</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-save_to_memcached" class="method-detail method-alias">
        <div class="method-heading">
          <span class="method-name">save_to_memcached</span><span
            class="method-args">()</span>
        </div>

        <div class="method-description">
          <p>Deprecated alias for <a href="Session.html#method-i-save_to_store"><code>save_to_store</code></a>, dating back to when the <a href="Session.html"><code>Session</code></a> engine was hard-coded to Memcached.</p>

        </div>


        <div class="aliases">
          Alias for: <a href="Session.html#method-i-save_to_store">save_to_store</a>
        </div>
      </div>

      <div id="method-i-save_to_store" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">save_to_store</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Save this session to the transient store, in a manner that will allow it to be loaded by <a href="Session.html#method-i-load_from_store-21"><code>load_from_store!</code></a> later.</p>

<p>A session can only be saved if it has a Caller ID - see <a href="Session.html#attribute-i-caller_id"><code>caller_id=</code></a> or the options hash passed to the constructor.</p>

<p>The <a href="Session.html#TTL"><code>Hoodoo::Services::Session::TTL</code></a> constant determines the maximum length of time for which the data persists inside the transient store.</p>

<p>Returns a symbol:</p>
<ul><li>
<p><code>:ok</code>: The session data was saved OK and is valid. There was either a Caller record with an earlier or matching value in the transient store, no preexisting record of the Caller.</p>
</li><li>
<p><code>:outdated</code>: The session data could not be saved because an existing Caller record was found in the transient store with a <em>newer</em> version than ‘this’ session, implying that the session is already outdated.</p>
</li><li>
<p><code>:fail</code>: The session data could not be saved.</p>
</li></ul>

          <div class="method-source-code" id="save_to_store-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 195</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">save_to_store</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">caller_id</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&#39;Hoodoo::Services::Session\#save_to_store: Cannot save this session as it has no assigned Caller UUID&#39;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">store</span> = <span class="ruby-identifier">get_store</span>()

    <span class="ruby-comment"># Try to update the Caller version in the store using this</span>
    <span class="ruby-comment"># Session&#39;s data. If this fails, the Caller version is out of</span>
    <span class="ruby-comment"># date or we couldn&#39;t talk to the store. Either way, bail out.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># TL;DR: The &#39;update&#39; call here is critical.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># This process refreshes the caller version information in the</span>
    <span class="ruby-comment"># transient store back-end with each new Session. If eventually the</span>
    <span class="ruby-comment"># Caller version is expired or evicted, Sessions would be immediately</span>
    <span class="ruby-comment"># invalidated and a recreation would result in the Caller version</span>
    <span class="ruby-comment"># being rewritten.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># What if the Caller goes out of date? An external service must gate</span>
    <span class="ruby-comment"># access to Caller resource changes and update the Caller version</span>
    <span class="ruby-comment"># itself if the Caller alters in a way that should invalidate</span>
    <span class="ruby-comment"># Sessions. This refreshes the lifetime on that item which normally</span>
    <span class="ruby-comment"># expires at a much greater TTL than sessions anyway and, if anyone</span>
    <span class="ruby-comment"># tries to use a Stale session after, the Caller version mismatch</span>
    <span class="ruby-comment"># will invalidate it so they&#39;ll need a new one.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># If a Caller version is created but somehow evicted before any of</span>
    <span class="ruby-comment"># the older existing Sessions (perhaps because Caller version data is</span>
    <span class="ruby-comment"># small but Session data is large) then attempts to read the Session</span>
    <span class="ruby-comment"># will fail; *loading* a Session requires the Caller version. The</span>
    <span class="ruby-comment"># Caller would have to create a new Session and this would by virtue</span>
    <span class="ruby-comment"># of the handling resource endpoint&#39;s service code acquire the new</span>
    <span class="ruby-comment"># Caller version data immediately then cause it to be re-asserted /</span>
    <span class="ruby-comment"># re-written by the code below.</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">update_caller_version_in_store</span>( <span class="ruby-keyword">self</span>.<span class="ruby-identifier">caller_id</span>,
                                             <span class="ruby-keyword">self</span>.<span class="ruby-identifier">caller_version</span>,
                                             <span class="ruby-identifier">store</span> )

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">equal?</span>( <span class="ruby-value">:ok</span> )

    <span class="ruby-comment"># Must set this before saving, even though the delay between</span>
    <span class="ruby-comment"># setting this value and the store actually saving the value</span>
    <span class="ruby-comment"># with a TTL will mean that the store expires the key slightly</span>
    <span class="ruby-comment"># *after* the time we record.</span>

    <span class="ruby-ivar">@expires_at</span> = ( <span class="ruby-operator">::</span><span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">+</span> <span class="ruby-constant">TTL</span> ).<span class="ruby-identifier">utc</span>()
    <span class="ruby-identifier">result</span>      = <span class="ruby-identifier">store</span>.<span class="ruby-identifier">set</span>( <span class="ruby-value">key:</span>              <span class="ruby-keyword">self</span>.<span class="ruby-identifier">session_id</span>,
                             <span class="ruby-value">payload:</span>          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">to_h</span>(),
                             <span class="ruby-value">maximum_lifespan:</span> <span class="ruby-constant">TTL</span> )

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">result</span>
      <span class="ruby-keyword">when</span> <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:ok</span>
      <span class="ruby-keyword">when</span> <span class="ruby-keyword">false</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-string">&#39;Unknown storage engine failure&#39;</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-identifier">result</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">rescue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">exception</span>

    <span class="ruby-comment"># Log error and return nil if the session can&#39;t be parsed</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span>(
      <span class="ruby-string">&#39;Hoodoo::Services::Session\#save_to_store: Session saving failed - connection fault or session corrupt&#39;</span>,
      <span class="ruby-identifier">exception</span>.<span class="ruby-identifier">to_s</span>
    )

  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-value">:fail</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>

        <div class="aliases">
          Also aliased as: <a href="Session.html#method-i-save_to_memcached">save_to_memcached</a>
        </div>

      </div>

      <div id="method-i-scoping-3D" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">scoping=</span><span
            class="method-args">( hash )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Set the scoping data via a Hash of key/value pairs - see also <a href="Session.html#attribute-i-scoping"><code>scoping</code></a>.</p>

          <div class="method-source-code" id="scoping-3D-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 97</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">scoping=</span>( <span class="ruby-identifier">hash</span> )
  <span class="ruby-ivar">@scoping</span> = <span class="ruby-constant">OpenStruct</span>.<span class="ruby-identifier">new</span>( <span class="ruby-identifier">hash</span> )
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-to_h" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">to_h</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Represent this session’s data as a Hash, for uses such as persistence or loading into another session instance. See also <a href="Session.html#method-i-from_h-21"><code>from_h!</code></a>.</p>

          <div class="method-source-code" id="to_h-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 528</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">to_h</span>
  <span class="ruby-identifier">hash</span> = {}

  <span class="ruby-node">%w(

    session_id
    caller_id
    caller_version
    caller_identity_name
    caller_fingerprint

  )</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">property</span> <span class="ruby-operator">|</span>
    <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span>( <span class="ruby-identifier">property</span> )
    <span class="ruby-identifier">hash</span>[ <span class="ruby-identifier">property</span> ] = <span class="ruby-identifier">value</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-node">%w(

    created_at
    expires_at

  )</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">property</span> <span class="ruby-operator">|</span>
    <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span>( <span class="ruby-identifier">property</span> )
    <span class="ruby-identifier">hash</span>[ <span class="ruby-identifier">property</span> ] = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Utilities</span>.<span class="ruby-identifier">standard_datetime</span>( <span class="ruby-identifier">value</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-node">%w(

    identity
    scoping
    permissions

  )</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">property</span> <span class="ruby-operator">|</span>
    <span class="ruby-identifier">value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">send</span>( <span class="ruby-identifier">property</span> )
    <span class="ruby-identifier">hash</span>[ <span class="ruby-identifier">property</span> ] = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Utilities</span>.<span class="ruby-identifier">stringify</span>( <span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_h</span>() ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">hash</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-update_caller_version_in_memcached" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">update_caller_version_in_memcached</span><span
            class="method-args">( cid, cv, store = nil )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Deprecated interface (use <a href="Session.html#method-i-update_caller_version_in_store"><code>update_caller_version_in_store</code></a> instead), dating back to when the <a href="Session.html"><code>Session</code></a> engine was hard-coded to Memcached.</p>

<p>Parameters as for <a href="Session.html#method-i-update_caller_version_in_store"><code>update_caller_version_in_store</code></a>, except <code>store</code> is must be a fully configured Dalli::Client instance. Use of this interface is inefficient and discouraged; it will result in logged warnings.</p>

          <div class="method-source-code" id="update_caller_version_in_memcached-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 437</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_caller_version_in_memcached</span>( <span class="ruby-identifier">cid</span>, <span class="ruby-identifier">cv</span>, <span class="ruby-identifier">store</span> = <span class="ruby-keyword">nil</span> )
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">store</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span>(
      <span class="ruby-string">&#39;Hoodoo::Services::Session#update_caller_version_in_memcached is deprecated - use #update_caller_version_in_store&#39;</span>
    )

    <span class="ruby-comment"># Inefficient - create a TransientStore configured for the normal</span>
    <span class="ruby-comment"># Memcached connection data, but get hold of its storage engine and</span>
    <span class="ruby-comment"># change that engine&#39;s client to the provided Dalli::Client instance.</span>

    <span class="ruby-identifier">temp_store</span> = <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">TransientStore</span>.<span class="ruby-identifier">new</span>(
      <span class="ruby-value">storage_engine:</span>    <span class="ruby-value">:memcached</span>,
      <span class="ruby-value">storage_host_uri:</span>  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">memcached_host</span>(),
      <span class="ruby-value">default_namespace:</span> <span class="ruby-string">&#39;nz_co_loyalty_hoodoo_session_&#39;</span>
    )

    <span class="ruby-identifier">memcached_engine</span>        = <span class="ruby-identifier">temp_store</span>.<span class="ruby-identifier">storage_engine_instance</span>()
    <span class="ruby-identifier">memcached_engine</span>.<span class="ruby-identifier">client</span> = <span class="ruby-identifier">store</span>

    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">update_caller_version_in_store</span>( <span class="ruby-identifier">cid</span>, <span class="ruby-identifier">cv</span>, <span class="ruby-identifier">temp_store</span> )
    <span class="ruby-keyword">ensure</span>
      <span class="ruby-identifier">temp_store</span>.<span class="ruby-identifier">close</span>()
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">update_caller_version_in_store</span>( <span class="ruby-identifier">cid</span>, <span class="ruby-identifier">cv</span> )

  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

      <div id="method-i-update_caller_version_in_store" class="method-detail ">
        <div class="method-heading">
          <span class="method-name">update_caller_version_in_store</span><span
            class="method-args">( cid, cv, store = nil )</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>

        <div class="method-description">
          <p>Update the version of a given Caller in the transient store. This is done automatically when Sessions are saved to that store, but if external code alters any Callers independently, it <strong>MUST</strong> call here to keep stored records up to date.</p>

<p>If no cached version is in the transient store for the Caller, the method assumes it is being called for the first time for that Caller and writes the version it has to hand, rather than considering it an error condition.</p>
<dl class="rdoc-list note-list"><dt><code>cid</code>
<dd>
<p>Caller <a href="../UUID.html"><code>UUID</code></a> of the Caller record to update.</p>
</dd><dt><code>cv</code>
<dd>
<p>New version to store (an Integer).</p>
</dd><dt><code>store</code>
<dd>
<p>Optional <a href="../TransientStore.html"><code>Hoodoo::TransientStore</code></a> instance to use for data storage. If omitted, a connection is established for you. This is mostly an optimisation parameter, used by code which already has established a connection and wants to avoid creating another unnecessarily.</p>
</dd></dl>

<p>Returns a Symbol:</p>
<ul><li>
<p><code>:ok</code>: The Caller record was updated successfully.</p>
</li><li>
<p><code>:outdated</code>: The Caller was already present in the transient store with a _higher version_ than the one you wanted to save. Your own local Caller data must therefore already be out of date.</p>
</li><li>
<p><code>:fail</code>: The Caller could not be updated (unexpected storage engine failure).</p>
</li></ul>

          <div class="method-source-code" id="update_caller_version_in_store-source">
            <pre><span class="ruby-comment"># File lib/hoodoo/services/services/session.rb, line 365</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">update_caller_version_in_store</span>( <span class="ruby-identifier">cid</span>, <span class="ruby-identifier">cv</span>, <span class="ruby-identifier">store</span> = <span class="ruby-keyword">nil</span> )
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">store</span>        <span class="ruby-operator">||=</span> <span class="ruby-identifier">get_store</span>()
    <span class="ruby-identifier">cached_version</span> = <span class="ruby-identifier">load_caller_version_from_store</span>( <span class="ruby-identifier">store</span>, <span class="ruby-identifier">cid</span> )

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">cached_version</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">cached_version</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">cv</span>
      <span class="ruby-keyword">return</span> <span class="ruby-value">:outdated</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">save_caller_version_to_store</span>( <span class="ruby-identifier">store</span>, <span class="ruby-identifier">cid</span>, <span class="ruby-identifier">cv</span> ) <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">return</span> <span class="ruby-value">:ok</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">rescue</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">exception</span>

    <span class="ruby-comment"># Log error and return nil if the session can&#39;t be parsed</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-constant">Hoodoo</span><span class="ruby-operator">::</span><span class="ruby-constant">Services</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span>(
      <span class="ruby-string">&#39;Hoodoo::Services::Session\#update_caller_version_in_store: Client version update - connection fault or corrupt record&#39;</span>,
      <span class="ruby-identifier">exception</span>.<span class="ruby-identifier">to_s</span>
    )

  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-value">:fail</span>
<span class="ruby-keyword">end</span></pre>
          </div>
        </div>


      </div>

    </section>

  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.4.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

